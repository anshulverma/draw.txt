<!DOCTYPE html>  <html> <head>   <title>draw.txt.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               draw.txt.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <pre><code>draw.txt
(c) 2011 Jon Beebe (somethingkindawierd@gmail.com)
draw.txt may be freely distributed under the MIT license.
For all details and documentation:
http://somethingkindawierd.github.com/draw.txt/
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h1>Controller</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>The main controller for the application.
I know, this file is a bit of a mess. It's been the catch-all for code before
I decide where I want it to live.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">({</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Bind all event listeners to this class instance</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Binds</span><span class="o">:</span> <span class="p">[</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p><em>Grid Events</em></p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="s1">&#39;whenMouseDown&#39;</span><span class="p">,</span>
          <span class="s1">&#39;whenMouseUp&#39;</span><span class="p">,</span>
          <span class="s1">&#39;whenMouseMove&#39;</span><span class="p">,</span>
          <span class="s1">&#39;whenGridCancel&#39;</span><span class="p">,</span>
          <span class="s1">&#39;whenGridDoubleClick&#39;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p><em>History Events</em></p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="s1">&#39;whenHistoryChange&#39;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p><em>Canvas Events</em></p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="s1">&#39;whenCanvasRefresh&#39;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p><em>Toolbar button events</em></p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="s1">&#39;whenUndo&#39;</span><span class="p">,</span>
          <span class="s1">&#39;whenRedo&#39;</span><span class="p">,</span>
          <span class="s1">&#39;whenDelete&#39;</span><span class="p">,</span>
          <span class="s1">&#39;whenEditMode&#39;</span><span class="p">,</span>
          <span class="s1">&#39;whenPreviewMode&#39;</span><span class="p">,</span>
          <span class="s1">&#39;whenMoveFront&#39;</span><span class="p">,</span>
          <span class="s1">&#39;whenMoveUp&#39;</span><span class="p">,</span>
          <span class="s1">&#39;whenMoveDown&#39;</span><span class="p">,</span>
          <span class="s1">&#39;whenMoveBack&#39;</span><span class="p">,</span>
          <span class="s1">&#39;whenOpen&#39;</span><span class="p">,</span>
          <span class="s1">&#39;whenSave&#39;</span>
  <span class="p">],</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h2>Class Properties</h2>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">background</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>

  <span class="nx">canvas</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>

  <span class="nx">history</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>

  <span class="nx">toolbar</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>

  <span class="nx">overlay</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>

  <span class="nx">localStorage</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Track user-actions</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">dragging</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>The command currently in-action</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">command</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>The first point of an action</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">clickLocation</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Offset of point relative to target DisplayObject's origin</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">clickOffset</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h2>Initialization</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Constructor</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">foreground</span><span class="p">,</span> <span class="nx">background</span><span class="p">,</span> <span class="nx">toolbar</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">grid</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Grid</span><span class="p">(</span><span class="nx">background</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">toolbar</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Toolbar</span><span class="p">(</span><span class="nx">toolbar</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Canvas</span><span class="p">(</span>
        <span class="nx">foreground</span><span class="p">,</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">(),</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">()</span>
    <span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">history</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">History</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>TODO: rework the use of overlays for setting artobject properties.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">overlay</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LightFace</span><span class="p">({</span>
      <span class="nx">width</span><span class="o">:</span> <span class="mi">400</span><span class="p">,</span>
      <span class="nx">height</span><span class="o">:</span> <span class="mi">200</span><span class="p">,</span>
      <span class="nx">draggable</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Edit Text&#39;</span><span class="p">,</span>
      <span class="nx">content</span><span class="o">:</span> <span class="s1">&#39;&lt;p&gt;This is the LightFace content!&lt;/p&gt;&#39;</span><span class="p">,</span>
      <span class="nx">buttons</span><span class="o">:</span> <span class="p">[</span>
          <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Ok&#39;</span><span class="p">,</span> <span class="nx">event</span><span class="o">:</span>
            <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">input</span> <span class="o">=</span> <span class="nx">$$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">messageBox</span><span class="p">).</span><span class="nx">getChildren</span><span class="p">(</span><span class="s1">&#39;textarea[name=&quot;text&quot;]&#39;</span><span class="p">);</span>
              <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">input</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
              <span class="kd">var</span> <span class="nx">mode</span> <span class="o">=</span> <span class="nx">input</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data-mode&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>

              <span class="k">if</span><span class="p">(</span><span class="nx">mode</span> <span class="o">===</span> <span class="s1">&#39;new&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">controller</span><span class="p">.</span><span class="nx">createText</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
              <span class="p">}</span>
              <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">mode</span> <span class="o">===</span> <span class="s1">&#39;edit&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">controller</span><span class="p">.</span><span class="nx">editText</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
              <span class="p">}</span>

              <span class="k">this</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="p">},</span> <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;blue&#39;</span> <span class="p">},</span>
          <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Cancel&#39;</span><span class="p">,</span> <span class="nx">event</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span> <span class="p">},</span> <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;default&#39;</span> <span class="p">}</span>
      <span class="p">],</span>
      <span class="nx">resetOnScroll</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">initEvents</span><span class="p">();</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">readLocalStorage</span><span class="p">();</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Initialize all event listeners</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">initEvents</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">listen</span><span class="p">({</span>
      <span class="nx">canvasRefresh</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">whenCanvasRefresh</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">listen</span><span class="p">({</span>
      <span class="nx">mousedown</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">whenMouseDown</span><span class="p">,</span>
      <span class="nx">mouseup</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">whenMouseUp</span><span class="p">,</span>
      <span class="nx">mousemove</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">whenMouseMove</span><span class="p">,</span>
      <span class="nx">cancel</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">whenGridCancel</span><span class="p">,</span>
      <span class="nx">dblclick</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">whenGridDoubleClick</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">toolbar</span><span class="p">.</span><span class="nx">listen</span><span class="p">({</span>
      <span class="nx">undo</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">whenUndo</span><span class="p">,</span>
      <span class="nx">redo</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">whenRedo</span><span class="p">,</span>
      <span class="s1">&#39;delete&#39;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">whenDelete</span><span class="p">,</span>
      <span class="nx">edit</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">whenEditMode</span><span class="p">,</span>
      <span class="nx">preview</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">whenPreviewMode</span><span class="p">,</span>
      <span class="nx">move_front</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">whenMoveFront</span><span class="p">,</span>
      <span class="nx">move_up</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">whenMoveUp</span><span class="p">,</span>
      <span class="nx">move_down</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">whenMoveDown</span><span class="p">,</span>
      <span class="nx">move_back</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">whenMoveBack</span><span class="p">,</span>
      <span class="nx">toggle_interface</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">whenToggleInterface</span><span class="p">,</span>
      <span class="nx">toggle_solid</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">whenToggleSolid</span><span class="p">,</span>
      <span class="nx">open</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">whenOpen</span><span class="p">,</span>
      <span class="nx">save</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">whenSave</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">listen</span><span class="p">({</span>
      <span class="nx">redo</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">whenHistoryChange</span><span class="p">,</span>
      <span class="nx">undo</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">whenHistoryChange</span>
    <span class="p">});</span>

  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Read in settings from local storage</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">readLocalStorage</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">st</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LocalStorage</span><span class="p">({</span><span class="nx">debug</span><span class="o">:</span><span class="kc">true</span><span class="p">}),</span>
        <span class="nx">theme</span> <span class="o">=</span> <span class="nx">st</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;theme&#39;</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">theme</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="nx">theme</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <h2>Event Listeners</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <h3>History Events</h3>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">whenHistoryChange</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">draw</span><span class="p">();</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <h3>General Interface events</h3>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">whenToggleSolid</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;should toggle shapes to solid or transparent...&#39;</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">whenToggleInterface</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">),</span>
        <span class="nx">st</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LocalStorage</span><span class="p">({</span><span class="nx">debug</span><span class="o">:</span><span class="kc">true</span><span class="p">});</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;dark&#39;</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;removing dark...&#39;</span><span class="p">);</span>
      <span class="nx">body</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;dark&#39;</span><span class="p">);</span>
      <span class="nx">st</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;theme&#39;</span><span class="p">,</span> <span class="s1">&#39;light&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;adding dark...&#39;</span><span class="p">);</span>
      <span class="nx">body</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;dark&#39;</span><span class="p">);</span>
      <span class="nx">st</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;theme&#39;</span><span class="p">,</span> <span class="s1">&#39;dark&#39;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <h3>Toolbar events</h3>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">whenEditMode</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;#right&#39;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">);</span>
    <span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;#left&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">whenPreviewMode</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;#right&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">);</span>
    <span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;#left&#39;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">whenDelete</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DeleteCommand</span><span class="p">();</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">setCanvas</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">);</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">setTarget</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getSelected</span><span class="p">());</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">setTargetIndex</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getIndexOfSelected</span><span class="p">());</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">c</span><span class="p">).</span><span class="nx">execute</span><span class="p">();</span>
  <span class="p">},</span>

  <span class="nx">whenUndo</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">undo</span><span class="p">();</span>
  <span class="p">},</span>

  <span class="nx">whenRedo</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">redo</span><span class="p">();</span>
  <span class="p">},</span>

  <span class="nx">whenOpen</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">reply</span><span class="p">,</span> <span class="nx">lfs</span><span class="p">,</span> <span class="nx">fileContents</span><span class="p">;</span>

    <span class="nx">reply</span> <span class="o">=</span> <span class="nx">prompt</span><span class="p">(</span><span class="s2">&quot;Name of file to open:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">reply</span> <span class="o">&amp;&amp;</span> <span class="nx">reply</span> <span class="o">!==</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>

      <span class="nx">lfs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getLocalStorage</span><span class="p">();</span>
      <span class="nx">fileContents</span> <span class="o">=</span> <span class="nx">lfs</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">reply</span><span class="p">);</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">fileContents</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">fromJSON</span><span class="p">(</span><span class="nx">fileContents</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;SUCCESS opening json!&#39;</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">draw</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span>

    <span class="p">}</span>

  <span class="p">},</span>

  <span class="nx">whenSave</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">reply</span> <span class="o">=</span> <span class="nx">prompt</span><span class="p">(</span><span class="s2">&quot;Name of file to save:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">reply</span> <span class="o">&amp;&amp;</span> <span class="nx">reply</span> <span class="o">!==</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">lfs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getLocalStorage</span><span class="p">();</span>
      <span class="nx">lfs</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">reply</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">());</span>
    <span class="p">}</span>

  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>TODO: for arrange commands, if already at to/bottom then do not perform command.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">whenMoveFront</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">indexA</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getIndexOfSelected</span><span class="p">(),</span>
        <span class="nx">command</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrangeFrontCommand</span><span class="p">();</span>

    <span class="nx">command</span><span class="p">.</span><span class="nx">setTarget</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getSelected</span><span class="p">());</span>
    <span class="nx">command</span><span class="p">.</span><span class="nx">setOriginalDepth</span><span class="p">(</span><span class="nx">indexA</span><span class="p">);</span>
    <span class="nx">command</span><span class="p">.</span><span class="nx">setCanvas</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">command</span><span class="p">).</span><span class="nx">execute</span><span class="p">();</span>
  <span class="p">},</span>

  <span class="nx">whenMoveUp</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">indexA</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getIndexOfSelected</span><span class="p">();</span>
        <span class="nx">indexB</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">command</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">indexA</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span> <span class="nx">indexB</span> <span class="o">=</span> <span class="nx">indexA</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">indexA</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">indexB</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">command</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrangeSwapCommand</span><span class="p">();</span>
      <span class="nx">command</span><span class="p">.</span><span class="nx">setCanvas</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">);</span>
      <span class="nx">command</span><span class="p">.</span><span class="nx">setBeginDepths</span><span class="p">([</span><span class="nx">indexA</span><span class="p">,</span> <span class="nx">indexB</span><span class="p">]);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">command</span><span class="p">).</span><span class="nx">execute</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">whenMoveDown</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">indexA</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getIndexOfSelected</span><span class="p">();</span>
        <span class="nx">indexB</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">command</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">indexA</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span> <span class="nx">indexB</span> <span class="o">=</span> <span class="nx">indexA</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">indexA</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">indexB</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">command</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrangeSwapCommand</span><span class="p">();</span>
      <span class="nx">command</span><span class="p">.</span><span class="nx">setCanvas</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">);</span>
      <span class="nx">command</span><span class="p">.</span><span class="nx">setBeginDepths</span><span class="p">([</span><span class="nx">indexA</span><span class="p">,</span> <span class="nx">indexB</span><span class="p">]);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">command</span><span class="p">).</span><span class="nx">execute</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">whenMoveBack</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">indexA</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getIndexOfSelected</span><span class="p">(),</span>
        <span class="nx">command</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrangeBackCommand</span><span class="p">();</span>

    <span class="nx">command</span><span class="p">.</span><span class="nx">setTarget</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getSelected</span><span class="p">());</span>
    <span class="nx">command</span><span class="p">.</span><span class="nx">setOriginalDepth</span><span class="p">(</span><span class="nx">indexA</span><span class="p">);</span>
    <span class="nx">command</span><span class="p">.</span><span class="nx">setCanvas</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">command</span><span class="p">).</span><span class="nx">execute</span><span class="p">();</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <h3>Mouse events on the grid</h3>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">whenGridDoubleClick</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">grid</span><span class="p">,</span> <span class="nx">ptA</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Did we hit an existing DisplayObject?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">hit</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">hitTest</span><span class="p">(</span><span class="nx">ptA</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">hit</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">setSelected</span><span class="p">(</span><span class="nx">hit</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">draw</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Store the offset of the click relative to the hit object's origin.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">clickOffset</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="nx">ptA</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">getX</span><span class="p">(),</span> <span class="nx">ptA</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">getY</span><span class="p">());</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">editShape</span><span class="p">(</span><span class="nx">ptA</span><span class="p">,</span> <span class="nx">ptA</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="p">},</span>

  <span class="nx">whenMouseDown</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">grid</span><span class="p">,</span> <span class="nx">ptA</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Record the location of the click</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">clickLocation</span> <span class="o">=</span> <span class="nx">ptA</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Reset all action-tracking properties</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">dragging</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">setSelected</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">command</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Did we hit an existing DisplayObject?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">hit</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">hitTest</span><span class="p">(</span><span class="nx">ptA</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>If we hit an object then decide which action to perform on it.
Currently we only move it, but eventually we will be able to resize
it as well.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">hit</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">setSelected</span><span class="p">(</span><span class="nx">hit</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">draw</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Store the offset of the click relative to the hit object's origin.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">clickOffset</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="nx">ptA</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">getX</span><span class="p">(),</span> <span class="nx">ptA</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">getY</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">whenMouseMove</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">grid</span><span class="p">,</span> <span class="nx">ptA</span><span class="p">,</span> <span class="nx">ptB</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>If we have not set the dragging flag, and the begin point &amp;
current point are different, then we are dragging...</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">dragging</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">ptA</span><span class="p">.</span><span class="nx">equals</span><span class="p">(</span><span class="nx">ptB</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">dragging</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Are we dragging across empty space on the grid?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">dragging</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getSelected</span><span class="p">())</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Draw the border of the dragged/selected area</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">markDraw</span><span class="p">(</span><span class="nx">ptA</span><span class="p">,</span> <span class="nx">ptB</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Are we moving an object?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getSelected</span><span class="p">())</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>We're moving an object! Create the move command and store the
original location of the box before repositioning it.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">command</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">beginMove</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">continueMove</span><span class="p">(</span><span class="nx">ptB</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">whenMouseUp</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">grid</span><span class="p">,</span> <span class="nx">ptA</span><span class="p">,</span> <span class="nx">ptB</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">newShape</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>If we have no selection on the canvas...</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getSelected</span><span class="p">())</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>If the user did not drag the mouse and did not hit existing art object...
We will create a text object.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">dragging</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">newShape</span> <span class="o">=</span> <span class="s1">&#39;text&#39;</span><span class="p">;</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Otherwise, make a box.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">newShape</span> <span class="o">=</span> <span class="s1">&#39;box&#39;</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">createShape</span><span class="p">(</span><span class="nx">newShape</span><span class="p">,</span> <span class="nx">ptA</span><span class="p">,</span> <span class="nx">ptB</span><span class="p">);</span>

    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>We have a selection. Do we edit it?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Only edit if the mouse has moved during this operation.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">dragging</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">editShape</span><span class="p">(</span><span class="nx">ptA</span><span class="p">,</span> <span class="nx">ptB</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">grid</span><span class="p">.</span><span class="nx">clearDraw</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Reset our action-tracking properties</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">command</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">dragging</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">whenGridCancel</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">grid</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">grid</span><span class="p">.</span><span class="nx">clearDraw</span><span class="p">();</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <h3>Canvas Events</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Respond to the canvas refreshing it's contents.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">whenCanvasRefresh</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">canvas</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Get the canvas contents as a text string.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">txt</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getText</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Show the text in the preview element.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;#txt&#39;</span><span class="p">).</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">cleanText</span><span class="p">(</span><span class="nx">txt</span><span class="p">));</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <h2>Interact with the canvas</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Catch-all for shape-edit actions.
Determine what the user is trying to do, and create/perform the command.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">editShape</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ptA</span><span class="p">,</span> <span class="nx">ptB</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>If we have an existing command, work with it...</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">command</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>If the begin and end point do not match then move the target object</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">ptA</span><span class="p">.</span><span class="nx">equals</span><span class="p">(</span><span class="nx">ptB</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">finalizeMove</span><span class="p">(</span><span class="nx">ptA</span><span class="p">,</span> <span class="nx">ptB</span><span class="p">);</span>
      <span class="p">}</span>

    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>No existing command...create one.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>If the user <em>did not</em> move their mouse when clicking...</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">ptA</span><span class="p">.</span><span class="nx">equals</span><span class="p">(</span><span class="nx">ptB</span><span class="p">))</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>If it's text, open the text-editor.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getSelected</span><span class="p">()</span> <span class="k">instanceof</span> <span class="nx">Text</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">getNewTextString</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getSelected</span><span class="p">().</span><span class="nx">getText</span><span class="p">(),</span> <span class="s1">&#39;edit&#39;</span><span class="p">);</span>
        <span class="p">}</span>

      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Begins a move command.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">beginMove</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">command</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MoveCommand</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">command</span><span class="p">.</span><span class="nx">setTarget</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getSelected</span><span class="p">());</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">command</span><span class="p">.</span><span class="nx">setBeginPoint</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getSelected</span><span class="p">().</span><span class="nx">getPosition</span><span class="p">());</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Move a dragged item as the user moves their mouse</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">continueMove</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ptB</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Find the new location of the object by offsetting the most recent
mouse position by the previously recorded click-offset.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">newLoc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="nx">ptB</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">clickOffset</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">ptB</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">clickOffset</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Tell the object we're moving where it's new location is.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getSelected</span><span class="p">().</span><span class="nx">setPosition</span><span class="p">(</span><span class="nx">newLoc</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Redraw the canvas.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">draw</span><span class="p">();</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Finalize a move command</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">finalizeMove</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ptA</span><span class="p">,</span> <span class="nx">ptB</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Find the new location of the object by offsetting the most recent
mouse position by the previously recorded click-offset.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">command</span><span class="p">.</span><span class="nx">setEndPoint</span><span class="p">(</span><span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="nx">ptB</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">clickOffset</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">ptB</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">clickOffset</span><span class="p">.</span><span class="nx">y</span><span class="p">));</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">command</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">editText</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">string</span> <span class="o">&amp;&amp;</span> <span class="nx">string</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getSelected</span><span class="p">().</span><span class="nx">getText</span><span class="p">())</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">command</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TextEditCommand</span><span class="p">();</span>
      <span class="nx">command</span><span class="p">.</span><span class="nx">setTarget</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getSelected</span><span class="p">());</span>
      <span class="nx">command</span><span class="p">.</span><span class="nx">setOriginalText</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getSelected</span><span class="p">().</span><span class="nx">getText</span><span class="p">());</span>
      <span class="nx">command</span><span class="p">.</span><span class="nx">setNewText</span><span class="p">(</span><span class="nx">string</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">command</span><span class="p">).</span><span class="nx">execute</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>Create a shape on the canvas</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">createShape</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">ptA</span><span class="p">,</span> <span class="nx">ptB</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">getNewTextString</span><span class="p">(</span><span class="s1">&#39;New Text&#39;</span><span class="p">,</span> <span class="s1">&#39;new&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;box&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">createBox</span><span class="p">(</span><span class="nx">ptA</span><span class="p">,</span> <span class="nx">ptB</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="p">},</span>

  <span class="nx">createText</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">props</span><span class="p">,</span> <span class="nx">text</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">props</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">x</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">clickLocation</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span>
        <span class="nx">y</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">clickLocation</span><span class="p">.</span><span class="nx">y</span>
      <span class="p">};</span>

      <span class="nx">text</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Text</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
      <span class="nx">text</span><span class="p">.</span><span class="nx">setText</span><span class="p">(</span><span class="nx">string</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CreateCommand</span><span class="p">();</span>
      <span class="nx">c</span><span class="p">.</span><span class="nx">setCanvas</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">);</span>
      <span class="nx">c</span><span class="p">.</span><span class="nx">setTarget</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Add the shape to the history.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">c</span><span class="p">).</span><span class="nx">execute</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">createBox</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ptA</span><span class="p">,</span> <span class="nx">ptB</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">,</span> <span class="nx">boxProps</span><span class="p">,</span> <span class="nx">box</span><span class="p">,</span> <span class="nx">c</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Calculate the bounds of the selected area on the grid.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">x</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">ptA</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">ptB</span><span class="p">.</span><span class="nx">x</span><span class="p">);</span>
    <span class="nx">y</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">ptA</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">ptB</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
    <span class="nx">width</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">ptB</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">ptA</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">-</span> <span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">height</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">ptB</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">ptA</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="o">-</span> <span class="nx">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>If we have an area greater than 1 cell, make a shape.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">width</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">height</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

      <span class="nx">boxProps</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">x</span><span class="o">:</span> <span class="nx">x</span><span class="p">,</span>
          <span class="nx">y</span><span class="o">:</span> <span class="nx">y</span><span class="p">,</span>
          <span class="nx">width</span><span class="o">:</span> <span class="nx">width</span><span class="p">,</span>
          <span class="nx">height</span><span class="o">:</span> <span class="nx">height</span><span class="p">,</span>
          <span class="nx">solid</span><span class="o">:</span> <span class="kc">true</span>
      <span class="p">};</span>

      <span class="nx">box</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Box</span><span class="p">(</span><span class="nx">boxProps</span><span class="p">);</span>

      <span class="nx">c</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CreateCommand</span><span class="p">();</span>
      <span class="nx">c</span><span class="p">.</span><span class="nx">setCanvas</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">);</span>
      <span class="nx">c</span><span class="p">.</span><span class="nx">setTarget</span><span class="p">(</span><span class="nx">box</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Add the shape to the history.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">c</span><span class="p">).</span><span class="nx">execute</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Clear the selection on the grid.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">clearDraw</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <h2>Other Controller Methods</h2>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">getNewTextString</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">mode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">overlay</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="s1">&#39;&lt;textarea type=&quot;text&quot; id=&quot;text&quot; data-mode=&quot;&#39;</span> <span class="o">+</span> <span class="nx">mode</span> <span class="o">+</span> <span class="s1">&#39;&quot; name=&quot;text&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nx">input</span> <span class="o">+</span> <span class="s1">&#39;&lt;/textarea&gt;&#39;</span><span class="p">).</span><span class="nx">open</span><span class="p">();</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>Getter for the canvas object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">getCanvas</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">getTextForSaving</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>Get the text and be silent about it</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">txt</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getText</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>Return the fixed text</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">cleanText</span><span class="p">(</span><span class="nx">txt</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">cleanText</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">blankRegex</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">Utilities</span><span class="p">.</span><span class="nx">blankChar</span> <span class="o">+</span> <span class="s2">&quot;\r?&quot;</span><span class="p">,</span> <span class="s1">&#39;gi&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">string</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">blankRegex</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;br\/&gt;\r?/g</span><span class="p">,</span> <span class="s2">&quot;\n&quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(&lt;[\/]?[a-zA-Z ]+)[^&gt;]*&gt;/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>Get the local storage engine.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">getLocalStorage</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">localStorage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LocalFileStorage</span><span class="p">({</span><span class="nx">namespace</span><span class="o">:</span> <span class="s1">&#39;draw.txt&#39;</span><span class="p">});</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>log the history to the console</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">debugHistory</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;History: [\n&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">debugDisplayList</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()));</span>
  <span class="p">},</span>

  <span class="nx">debugFromJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">fromJSON</span><span class="p">(</span><span class="nx">json</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;SUCCESS opening json!&#39;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">draw</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;FAILED to open json :(&#39;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="p">});</span> <span class="cm">/* &lt;/ Controller &gt; */</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <h2>Array Enhancements</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">Array</span><span class="p">.</span><span class="nx">implement</span><span class="p">({</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>Merge any number of arrays into a single array</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">merge</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">combine</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">merged</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nb">Array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">merged</span><span class="p">.</span><span class="nx">combine</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">combine</span><span class="p">(</span><span class="nx">merged</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <h2>String Enhancements</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">String</span><span class="p">.</span><span class="nx">implement</span><span class="p">({</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>Force the first letter of a string to lowercase.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">lowercaseFirstLetter</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <h2>Event Enhancements</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Events</span><span class="p">.</span><span class="nx">implement</span><span class="p">({</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>Add event listeners en masse</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">listen</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">events</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">events</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">eventType</span><span class="p">,</span> <span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span><span class="nx">eventType</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>Remove event listeners en masse</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">stopListening</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">events</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">events</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">eventType</span><span class="p">,</span> <span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">removeEvent</span><span class="p">(</span><span class="nx">eventType</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <h2>Options Enhancements</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Options</span><span class="p">.</span><span class="nx">implement</span><span class="p">({</span>
  
  <span class="nx">getOption</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">opt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="nx">opt</span><span class="p">];</span>
  <span class="p">},</span>
  
  <span class="nx">setOption</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">opt</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="nx">opt</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">}</span>
  
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <h2>Utilities Namespace</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>A place for things to live until I find a better place for them...</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Utilities</span> <span class="o">=</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>Define a blank html character. We need to do this because iOS 
<a href="http://www.cocoabuilder.com/archive/cocoa/296556-ios-monospaced-fonts-aren.html">does not display monospace fonts correctly</a></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">Browser</span><span class="p">.</span><span class="nx">Platform</span><span class="p">.</span><span class="nx">ipod</span><span class="p">){</span>
  <span class="nx">Utilities</span><span class="p">.</span><span class="nx">blankChar</span> <span class="o">=</span> <span class="s1">&#39;&lt;span class=&quot;sp&quot;&gt;-&amp;#8203;&lt;/span&gt;&#39;</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
  <span class="nx">Utilities</span><span class="p">.</span><span class="nx">blankChar</span> <span class="o">=</span> <span class="s1">&#39;&amp;nbsp;&#39;</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <h1>Character Grid Class</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>A two-dimensional array, or grid, for storing a matrix of characters.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">CharacterGrid</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">({</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>Main array holding rows, or arrays of characters (lines of text)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">a</span><span class="o">:</span> <span class="p">[],</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>The width of the grid of characters.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">w</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>The height of the grid of characters.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">h</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>Default character for empty cells in the grid.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kr">char</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>Constructor</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="kr">char</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">w</span> <span class="o">=</span> <span class="nx">w</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">h</span> <span class="o">=</span> <span class="nx">h</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="kr">char</span> <span class="o">=</span> <span class="kr">char</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>
  <span class="p">},</span>

  <span class="nx">reset</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fillWith</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>Create an empty grid. Fill all cells with the default character.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">create</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">h</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fill</span><span class="p">();</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>Fill the entire grid with a single character, useful for clearing the grid.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">fill</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">c</span> <span class="o">=</span> <span class="nx">c</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="kr">char</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">h</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">a</span><span class="p">[</span><span class="nx">y</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">w</span><span class="p">);</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">a</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="kr">char</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">getArray</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">a</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="nb">Array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">a</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">t</span> <span class="o">+=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;br/&gt;&#39;</span><span class="p">;</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">t</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <h1>Point</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>A very basic point class</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Point</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">({</span></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>x coordinate value</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">x</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>y coordinate value</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">y</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p>Constructor</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">y</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>Test the equality of this point to the input point.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">equals</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">===</span> <span class="nx">pt</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">===</span> <span class="nx">pt</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>Render to string</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">&#39;{x:&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="s1">&#39;, y:&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <h1>Toolbar Class</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p>Define a basic toolbar for managing buttons in app.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Toolbar</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">({</span></pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>Our toolbar element</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">elem</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p>Constructor</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">elem</span> <span class="o">=</span> <span class="nx">$$</span><span class="p">(</span><span class="nx">selector</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p>Listen to a click on our toolbar. The specific button clicked will be
identified in the event handler.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">elem</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">whenClick</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p>Add event listeners to the toolbar element en masse.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">listen</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">events</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">events</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">eventType</span><span class="p">,</span> <span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">elem</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span><span class="nx">eventType</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>Respond to the user clicking on our toolbar. Identify the button clicked
dispatch the corresponding button event.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">whenClick</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;div&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">elem</span><span class="p">.</span><span class="nx">fireEvent</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <h1>History</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p>The History class for storing the user's actions in time.
Paired with the Command class, it provides for a basic undo/redo system.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">History</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">({</span>

  <span class="nx">Implements</span><span class="o">:</span> <span class="p">[</span><span class="nx">Options</span><span class="p">,</span> <span class="nx">Events</span><span class="p">],</span></pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p>Options? Not used yet...they're optional!</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">options</span><span class="o">:</span> <span class="p">{},</span></pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>Array of actions</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">stack</span><span class="o">:</span> <span class="p">[],</span></pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>Current position within history. This is incremented/decremented as
undo/redo move through the history.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">pos</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p>Constructor</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p>Clear the history stack.
Returns the history array in case we want to restore it later.
If you want to permanently clear the history, just ignore the return result.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">clear</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">h</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">stack</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">h</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <p>Undo the previous action.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">undo</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
      <span class="nx">c</span><span class="p">.</span><span class="nx">revert</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="o">--</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">fireEvent</span><span class="p">(</span><span class="s1">&#39;undo&#39;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <p>Redo the action at current position.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">redo</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">&lt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">];</span>
      <span class="nx">c</span><span class="p">.</span><span class="nx">execute</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="o">++</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">fireEvent</span><span class="p">(</span><span class="s1">&#39;redo&#39;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <p>Add a new command to the history.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">add</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">command</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-117">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-117">&#182;</a>               </div>               <p>If we are not at the end of the history stack then the user has
undone some commands. Remove all commands past the current position.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">stack</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-118">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-118">&#182;</a>               </div>               <p>Add the new command to the history</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">command</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="o">++</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-119">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-119">&#182;</a>               </div>               <p>Return this so we can chain...</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">execute</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">execute</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fireEvent</span><span class="p">(</span><span class="s1">&#39;redo&#39;</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">array</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">s</span> <span class="o">+=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;\n&quot;</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">s</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-120">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-120">&#182;</a>               </div>               <h1>Command Interface</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-121">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-121">&#182;</a>               </div>               <p>The base command class.
All specific commands should implement this interface.</p>

<ul>
<li>Expects a <code>DisplayObject</code> as its target. </li>
<li>Implements an <code>execute</code> method to apply the command, and</li>
<li>implements a <code>revert</code> method to undo the command.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">ICommand</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">({</span></pre></div>             </td>           </tr>                               <tr id="section-122">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-122">&#182;</a>               </div>               <p>The target DisplayObject to apply this command to.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">target</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-123">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-123">&#182;</a>               </div>               <p>The canvas where DisplayObjects are drawn.
Here for convenience. Not all commands require this.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">canvas</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-124">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-124">&#182;</a>               </div>               <p>Constructor</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{},</span></pre></div>             </td>           </tr>                               <tr id="section-125">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-125">&#182;</a>               </div>               <p>Override this method in child classes
Set the target to its original state before this command was applied.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">revert</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="s2">&quot;Command classes must implement the &#39;revert&#39; method&quot;</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-126">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-126">&#182;</a>               </div>               <p>Override this method in child classes
Apply command -- target will be in new state after changes applied.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">execute</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="s2">&quot;Command classes must implement the &#39;execute&#39; method&quot;</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">setTarget</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">target</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">getTarget</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">setCanvas</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-127">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-127">&#182;</a>               </div>               <p>Override toString this for debugging of commands.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="s2">&quot;Command classes must implement their own toString methods&quot;</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-128">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-128">&#182;</a>               </div>               <h1>Create Command</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-129">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-129">&#182;</a>               </div>               <p>Create a new DisplayObject.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">CreateCommand</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">({</span>

  <span class="nx">Implements</span><span class="o">:</span> <span class="nx">ICommand</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-130">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-130">&#182;</a>               </div>               <p>The target DisplayObject to be created on execute, removed on revert.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">target</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-131">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-131">&#182;</a>               </div>               <p>Constructor</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{},</span></pre></div>             </td>           </tr>                               <tr id="section-132">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-132">&#182;</a>               </div>               <p>Add the target DisplayObject to the canvas.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">execute</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">addChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">);</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-133">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-133">&#182;</a>               </div>               <p>Remove the target DisplayObject from the canvas.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">revert</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">&#39;{name: Create, target: &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-134">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-134">&#182;</a>               </div>               <h1>Delete Command</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-135">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-135">&#182;</a>               </div>               <p>Remove a DisplayObject from the display list.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DeleteCommand</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">({</span>

  <span class="nx">Implements</span><span class="o">:</span> <span class="nx">ICommand</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-136">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-136">&#182;</a>               </div>               <p>The index where target DisplayObject lived prior to deletion</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">targetIndex</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-137">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-137">&#182;</a>               </div>               <p>Constructor</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){},</span>

  <span class="nx">setTargetIndex</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">targetIndex</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-138">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-138">&#182;</a>               </div>               <p>Remove the target from the canvas</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">execute</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">removeChildAt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">targetIndex</span><span class="p">);</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-139">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-139">&#182;</a>               </div>               <p>Place target back in the display list</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">revert</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">addChildAt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">targetIndex</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">&#39;{name: Delete, target: &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-140">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-140">&#182;</a>               </div>               <h1>Move Command</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-141">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-141">&#182;</a>               </div>               <p>Move a display object.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">MoveCommand</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">({</span>

  <span class="nx">Implements</span><span class="o">:</span> <span class="nx">ICommand</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-142">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-142">&#182;</a>               </div>               <p>The original location.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">ptA</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-143">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-143">&#182;</a>               </div>               <p>The new location.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">ptB</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-144">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-144">&#182;</a>               </div>               <p>Constructor</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{},</span></pre></div>             </td>           </tr>                               <tr id="section-145">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-145">&#182;</a>               </div>               <p>Move the target to the new location.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">execute</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">setPosition</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ptB</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">refresh</span><span class="p">();</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-146">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-146">&#182;</a>               </div>               <p>Place the target object back in its original location.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">revert</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">setPosition</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ptA</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">refresh</span><span class="p">();</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-147">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-147">&#182;</a>               </div>               <p>Set the original location of the target.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">setBeginPoint</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ptA</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-148">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-148">&#182;</a>               </div>               <p>Set the new location of the target.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">setEndPoint</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ptB</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">&#39;{name: Move, ptA: &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">ptA</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span>
           <span class="s1">&#39;, ptB: &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">ptB</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-149">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-149">&#182;</a>               </div>               <h1>Text Edit Command</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-150">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-150">&#182;</a>               </div>               <p>Edit the textual content of a Text Display Object</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">TextEditCommand</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">({</span>

  <span class="nx">Implements</span><span class="o">:</span> <span class="nx">ICommand</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-151">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-151">&#182;</a>               </div>               <p>The target DisplayObject to be edited.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">target</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-152">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-152">&#182;</a>               </div>               <p>The text string prior to applying this command.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">originalText</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-153">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-153">&#182;</a>               </div>               <p>The new text string to apply using this command.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">newText</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-154">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-154">&#182;</a>               </div>               <p>Constructor</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{},</span>

  <span class="nx">setOriginalText</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">originalText</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">setNewText</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">newText</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">execute</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">setText</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">newText</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">revert</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">setText</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">originalText</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">&#39;{name: TextEdit, originalText: &quot;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">originalText</span> <span class="o">+</span>
           <span class="s1">&#39;&quot;, newText: &quot;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">newText</span> <span class="o">+</span> <span class="s1">&#39;&quot;}&#39;</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-155">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-155">&#182;</a>               </div>               <h1>Arrange to front Command</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-156">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-156">&#182;</a>               </div>               <p>Send a DisplayObject to the front of the display list</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">ArrangeFrontCommand</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">({</span>

  <span class="nx">Implements</span><span class="o">:</span> <span class="nx">ICommand</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-157">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-157">&#182;</a>               </div>               <p>The depth of DisplayObject prior to applying this command.
We don't need to store the new depth because we know it'll be the top
of the display list array.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">originalDepth</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>

  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){},</span></pre></div>             </td>           </tr>                               <tr id="section-158">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-158">&#182;</a>               </div>               <p>Move the target to the new depth.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">execute</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-159">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-159">&#182;</a>               </div>               <p>This command does not require you to set the target manually. If you've
set the original depth we can grab the target located there.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">target</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getChildAt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">originalDepth</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-160">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-160">&#182;</a>               </div>               <p>The addChild method automatically inserts the DisplayObject at the top.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">addChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">);</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-161">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-161">&#182;</a>               </div>               <p>Place the target object back in its original depth.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">revert</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">addChildAt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">originalDepth</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">setOriginalDepth</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">originalDepth</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">&#39;{name: ArrangeFront, originalDepth: &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">originalDepth</span> <span class="o">+</span>
           <span class="s1">&#39;, target: &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-162">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-162">&#182;</a>               </div>               <h1>Arrange to Back Command</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-163">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-163">&#182;</a>               </div>               <p>Send a DisplayObject to the back of the display list</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">ArrangeBackCommand</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">({</span>

  <span class="nx">Implements</span><span class="o">:</span> <span class="nx">ICommand</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-164">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-164">&#182;</a>               </div>               <p>The depth of DisplayObject prior to applying this command.
We don't need to store the new depth because we know it'll be the bottom
of the display list array -- 0</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">originalDepth</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>

  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){},</span></pre></div>             </td>           </tr>                               <tr id="section-165">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-165">&#182;</a>               </div>               <p>Move the target to the new depth.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">execute</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-166">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-166">&#182;</a>               </div>               <p>This command does not require you to set the target manually. If you've
set the original depth we can grab the target located there.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">target</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getChildAt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">originalDepth</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">addChildAt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-167">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-167">&#182;</a>               </div>               <p>Place the target object back in its original depth.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">revert</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">addChildAt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">originalDepth</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">setOriginalDepth</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">originalDepth</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">&#39;{name: ArrangeBack, originalDepth: &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">originalDepth</span> <span class="o">+</span>
           <span class="s1">&#39;, target: &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-168">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-168">&#182;</a>               </div>               <h1>Rearrange Command</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-169">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-169">&#182;</a>               </div>               <p>Swap two DisplayObjects</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">ArrangeSwapCommand</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">({</span>

  <span class="nx">Implements</span><span class="o">:</span> <span class="nx">ICommand</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-170">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-170">&#182;</a>               </div>               <p>Store the beginning depths of the target DisplayObjects</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">beginDepths</span><span class="o">:</span> <span class="p">[],</span>

  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){},</span></pre></div>             </td>           </tr>                               <tr id="section-171">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-171">&#182;</a>               </div>               <p>Swap the two display objects to their new depths.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">execute</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">swapChildren</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">beginDepths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">this</span><span class="p">.</span><span class="nx">beginDepths</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-172">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-172">&#182;</a>               </div>               <p>Place the target DisplayObjects at original depth.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">revert</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">swapChildren</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">beginDepths</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="k">this</span><span class="p">.</span><span class="nx">beginDepths</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="p">},</span>

  <span class="nx">setBeginDepths</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">beginDepths</span> <span class="o">=</span> <span class="nx">a</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">&#39;{name: ArrangeSwap, ptA: &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">beginDepths</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span>
           <span class="s1">&#39;, ptB: &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">beginDepths</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-173">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-173">&#182;</a>               </div>               <h1>Grid</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-174">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-174">&#182;</a>               </div>               <p>Defined the character grid to draw within.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Grid</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">({</span></pre></div>             </td>           </tr>                               <tr id="section-175">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-175">&#182;</a>               </div>               <p>Bind these event handlers to this class instance</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Binds</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;mouseDown&#39;</span><span class="p">,</span>
          <span class="s1">&#39;mouseMove&#39;</span><span class="p">,</span>
          <span class="s1">&#39;mouseUp&#39;</span><span class="p">,</span>
          <span class="s1">&#39;doubleClick&#39;</span><span class="p">],</span>

  <span class="nx">Implements</span><span class="o">:</span> <span class="nx">Events</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-176">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-176">&#182;</a>               </div>               <p>This is the dom elem to target.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">elem</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-177">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-177">&#182;</a>               </div>               <p>Are we using touch instead of mouse clicks?</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">touch</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-178">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-178">&#182;</a>               </div>               <p>The size of our dom element.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">size</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-179">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-179">&#182;</a>               </div>               <p>This is the pixel size of a single monospaced letter {x:#, y:#}.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">em</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-180">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-180">&#182;</a>               </div>               <p>The width of our background in characters.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">width</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-181">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-181">&#182;</a>               </div>               <p>The height of our background in characters.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">height</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-182">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-182">&#182;</a>               </div>               <p>The first point of an action.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">ptA</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-183">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-183">&#182;</a>               </div>               <p>The most recent point of an action.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">ptB</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-184">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-184">&#182;</a>               </div>               <p>Constructor.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">elem</span> <span class="o">=</span> <span class="nx">$$</span><span class="p">(</span><span class="nx">selector</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">Browser</span><span class="p">.</span><span class="nx">Platform</span><span class="p">.</span><span class="nx">ipod</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">touch</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Touch</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">touch</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouseDown</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">elem</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span><span class="s1">&#39;mousedown&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouseDown</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">elem</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span><span class="s1">&#39;dblclick&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">doubleClick</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">drawGrid</span><span class="p">();</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-185">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-185">&#182;</a>               </div>               <h2>Mouse Events</h2>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">doubleClick</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">ptA</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">findClickLocation</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fireEvent</span><span class="p">(</span><span class="s1">&#39;dblclick&#39;</span><span class="p">,</span> <span class="p">[</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">ptA</span><span class="p">]);</span>

    <span class="nx">e</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

  <span class="p">},</span>

  <span class="nx">mouseDown</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">touch</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">touch</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span><span class="s1">&#39;move&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouseMove</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">touch</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouseUp</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">touch</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span><span class="s1">&#39;cancel&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouseUp</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">addEvent</span><span class="p">(</span><span class="s1">&#39;mouseup&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouseUp</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">elem</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span><span class="s1">&#39;mousemove&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouseMove</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">ptA</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">findClickLocation</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ptB</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ptA</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">fireEvent</span><span class="p">(</span><span class="s1">&#39;mousedown&#39;</span><span class="p">,</span> <span class="p">[</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">ptA</span><span class="p">]);</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">touch</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-186">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-186">&#182;</a>               </div>               <p><code>e</code> comes from both mouse move and touch move events.
<code>dx</code>, and <code>dy</code> only apply to touch move events.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">mouseMove</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">dx</span><span class="p">,</span> <span class="nx">dy</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">parent</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-187">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-187">&#182;</a>               </div>               <p>If this was a touch event then we must calculate the position using the
touch event's delta, converting pixel units to character units.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">touch</span><span class="p">)</span> <span class="p">{</span>

      <span class="nx">x</span> <span class="o">=</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">ptA</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">em</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">+</span> <span class="nx">dx</span><span class="p">)</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">em</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
      <span class="nx">y</span> <span class="o">=</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">ptA</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">em</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="o">+</span> <span class="nx">dy</span><span class="p">)</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">em</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">ptB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">x</span><span class="p">),</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">y</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">ptB</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">findClickLocation</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">parent</span> <span class="o">=</span> <span class="nx">$$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">getParents</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">elem</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">));</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">parent</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">fireEvent</span><span class="p">(</span><span class="s1">&#39;mousemove&#39;</span><span class="p">,</span> <span class="p">[</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">ptA</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">ptB</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">touch</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

  <span class="p">},</span>

  <span class="nx">mouseUp</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-188">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-188">&#182;</a>               </div>               <p>Clean up event listeners since the user's action is complete.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">touch</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">touch</span><span class="p">.</span><span class="nx">removeEvent</span><span class="p">(</span><span class="s1">&#39;move&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouseMove</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">touch</span><span class="p">.</span><span class="nx">removeEvent</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouseUp</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">removeEvent</span><span class="p">(</span><span class="s1">&#39;mouseup&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouseUp</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">elem</span><span class="p">.</span><span class="nx">removeEvent</span><span class="p">(</span><span class="s1">&#39;mousemove&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouseMove</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">fireEvent</span><span class="p">(</span><span class="s1">&#39;mouseup&#39;</span><span class="p">,</span> <span class="p">[</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">ptA</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">ptB</span><span class="p">]);</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">touch</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-189">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-189">&#182;</a>               </div>               <h2>DOM Work</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-190">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-190">&#182;</a>               </div>               <p>Draw the grid of squares representing our editable area.
Each square is akin to a pixel, and is the exact same size a
single monospace character.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">drawGrid</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">top</span><span class="p">,</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-191">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-191">&#182;</a>               </div>               <p>Calculate the width and height of the grid</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">size</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">elem</span><span class="p">.</span><span class="nx">getSize</span><span class="p">()[</span><span class="mi">0</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-192">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-192">&#182;</a>               </div>               <p>Find the width and height of a single monospaced character</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">em</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getEmSize</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-193">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-193">&#182;</a>               </div>               <p>Calculate the width and height of grid in characters</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">x</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">em</span><span class="p">.</span><span class="nx">x</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">y</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">em</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-194">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-194">&#182;</a>               </div>               <p>Create our grid</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-195">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-195">&#182;</a>               </div>               <p>Loop through each row of our grid...</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span><span class="p">(</span><span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-196">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-196">&#182;</a>               </div>               <p>Find the top of this row</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">top</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">em</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">y</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-197">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-197">&#182;</a>               </div>               <p>For this row, loop through each item...</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span><span class="p">(</span><span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-198">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-198">&#182;</a>               </div>               <p>Find the left of this item</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">left</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">em</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-199">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-199">&#182;</a>               </div>               <p>Create the dom element</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">e</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createBox</span><span class="p">(</span><span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">+</span> <span class="s1">&#39;r&#39;</span> <span class="o">+</span> <span class="nx">y</span><span class="p">,</span>
            <span class="nx">left</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="nx">top</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">em</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">em</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span>
        <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-200">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-200">&#182;</a>               </div>               <p>Store the x and y coordinates of this item in data attributes</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">e</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;data-x&#39;</span><span class="p">,</span> <span class="nx">x</span><span class="p">);</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;data-y&#39;</span><span class="p">,</span> <span class="nx">y</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-201">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-201">&#182;</a>               </div>               <p>Add classes based on the location of this square within the grid</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">y</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">e</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">);</span> <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">y</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="nx">e</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">);</span> <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">x</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">e</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">);</span> <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">x</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="nx">e</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">);</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-202">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-202">&#182;</a>               </div>               <p>Render this grid to DOM</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">elem</span><span class="p">.</span><span class="nx">adopt</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-203">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-203">&#182;</a>               </div>               <p>Create a span element</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">createSpan</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">h</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">(</span><span class="s1">&#39;span&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">id</span><span class="o">:</span><span class="nx">id</span><span class="p">});</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">e</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-204">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-204">&#182;</a>               </div>               <p>Create a box, or <div>, element</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">createBox</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">h</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">id</span><span class="o">:</span><span class="nx">id</span><span class="p">,</span> <span class="s1">&#39;class&#39;</span><span class="o">:</span> <span class="s1">&#39;bgbox&#39;</span><span class="p">});</span>

    <span class="nx">e</span><span class="p">.</span><span class="nx">setStyles</span><span class="p">({</span>
      <span class="nx">width</span><span class="o">:</span> <span class="nx">w</span><span class="p">,</span>
      <span class="nx">height</span><span class="o">:</span> <span class="nx">h</span><span class="p">,</span>
      <span class="nx">left</span><span class="o">:</span>  <span class="nx">x</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">,</span>
      <span class="nx">top</span><span class="o">:</span> <span class="nx">y</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">,</span>
      <span class="nx">position</span><span class="o">:</span> <span class="s1">&#39;absolute&#39;</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">e</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-205">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-205">&#182;</a>               </div>               <p>Clear the bounding box preview from the dom</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">clearDraw</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;.preview&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;preview&#39;</span><span class="p">);</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-206">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-206">&#182;</a>               </div>               <p>Mark the cells of the user's current bounding box.
Given an origin point and end point, calculate the box and draw it.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">markDraw</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ptA</span><span class="p">,</span> <span class="nx">ptB</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="cm">/* @private */</span></pre></div>             </td>           </tr>                               <tr id="section-207">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-207">&#182;</a>               </div>               <p>The cells marking the bounding box</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">left</span><span class="p">,</span> <span class="nx">right</span><span class="p">,</span> <span class="nx">top</span><span class="p">,</span> <span class="nx">bottom</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-208">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-208">&#182;</a>               </div>               <p>The bounds of the box</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">x</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">ptA</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">ptB</span><span class="p">.</span><span class="nx">x</span><span class="p">),</span>
    <span class="nx">y</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">ptA</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">ptB</span><span class="p">.</span><span class="nx">y</span><span class="p">),</span>
    <span class="nx">width</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">ptB</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">ptA</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">-</span> <span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nx">height</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">ptB</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">ptA</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="o">-</span> <span class="nx">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">width</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">height</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-209">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-209">&#182;</a>               </div>               <p>Find all the cells defining the bounding box</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">left</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">elem</span><span class="p">.</span><span class="nx">getChildren</span><span class="p">(</span><span class="s1">&#39;[data-x=&#39;</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span> <span class="nx">y</span><span class="o">+</span><span class="nx">height</span><span class="p">);</span>
      <span class="nx">right</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">elem</span><span class="p">.</span><span class="nx">getChildren</span><span class="p">(</span><span class="s1">&#39;[data-x=&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span> <span class="nx">y</span><span class="o">+</span><span class="nx">height</span><span class="p">);</span>
      <span class="nx">top</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">elem</span><span class="p">.</span><span class="nx">getChildren</span><span class="p">(</span><span class="s1">&#39;[data-y=&#39;</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
      <span class="nx">bottom</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">elem</span><span class="p">.</span><span class="nx">getChildren</span><span class="p">(</span><span class="s1">&#39;[data-y=&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-210">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-210">&#182;</a>               </div>               <p>Clear all previously marked cells</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">clearDraw</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-211">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-211">&#182;</a>               </div>               <p>Mark all cells in the bounding box</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">markPreviewCells</span><span class="p">([].</span><span class="nx">merge</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span> <span class="nx">right</span><span class="p">,</span> <span class="nx">top</span><span class="p">,</span> <span class="nx">bottom</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-212">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-212">&#182;</a>               </div>               <p>Mark all given cells with '.preview' to show the user the bounds of the
box they've draw.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">markPreviewCells</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">items</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-213">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-213">&#182;</a>               </div>               <p>Array.each(items, function(item, index, obj) {
     item.addClass('preview');
   });</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">tempElements</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Elements</span><span class="p">(</span><span class="nx">items</span><span class="p">);</span>
    <span class="nx">tempElements</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;preview&#39;</span><span class="p">);</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-214">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-214">&#182;</a>               </div>               <h2>Getters</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-215">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-215">&#182;</a>               </div>               <p>Get the width of our grid, in characters</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">getWidth</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-216">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-216">&#182;</a>               </div>               <p>Get the height of our grid, in characters</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">getHeight</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-217">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-217">&#182;</a>               </div>               <p>Calculate the size of a single monospaced character, both width and height,
by creating a single M and measuring it's size.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">getEmSize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createSpan</span><span class="p">(</span><span class="s1">&#39;tempSpan&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;1em&#39;</span><span class="p">,</span> <span class="s1">&#39;1em&#39;</span><span class="p">),</span>
    <span class="nx">emSize</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">letterSpacing</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">elem</span><span class="p">.</span><span class="nx">adopt</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="nx">emSize</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">getSize</span><span class="p">();</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">dispose</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">emSize</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-218">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-218">&#182;</a>               </div>               <p>Find the click location on our grid. This is not a pixel value, but rather
the x and y location within our grid matrix.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">findClickLocation</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">elem</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data-x&#39;</span><span class="p">),</span>
        <span class="nx">y</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">elem</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data-y&#39;</span><span class="p">);</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">);</span>

  <span class="p">}</span>

<span class="p">});</span> <span class="cm">/* &lt;/ Grid &gt; */</span></pre></div>             </td>           </tr>                               <tr id="section-219">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-219">&#182;</a>               </div>               <h1>Artboard for drawing</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-220">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-220">&#182;</a>               </div>               <p>This is where you do your drawing...</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Canvas</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">({</span>

  <span class="nx">Implements</span><span class="o">:</span> <span class="nx">Events</span><span class="p">,</span>

  <span class="nx">elem</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-221">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-221">&#182;</a>               </div>               <p>Our list of DisplayObjects</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">displayList</span><span class="o">:</span> <span class="p">[],</span></pre></div>             </td>           </tr>                               <tr id="section-222">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-222">&#182;</a>               </div>               <p>Our matrix of text characters making up our display</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">characterGrid</span><span class="o">:</span> <span class="p">[],</span></pre></div>             </td>           </tr>                               <tr id="section-223">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-223">&#182;</a>               </div>               <p>Here we store our display as a string</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">txt</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>

  <span class="nx">width</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>

  <span class="nx">height</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-224">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-224">&#182;</a>               </div>               <p>Store the currently selected DisplayObject</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">selected</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-225">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-225">&#182;</a>               </div>               <p>Constructor</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">h</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">elem</span> <span class="o">=</span> <span class="nx">$$</span><span class="p">(</span><span class="nx">selector</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">w</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">h</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-226">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-226">&#182;</a>               </div>               <p>Initialize our display matrix</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">initMatrix</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">h</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">characterGrid</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CharacterGrid</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">Utilities</span><span class="p">.</span><span class="nx">blankChar</span><span class="p">);</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-227">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-227">&#182;</a>               </div>               <p>Manage the currently selected DisplayObject</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">setSelected</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">selected</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span> <span class="p">},</span>
  <span class="nx">getSelected</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">selected</span><span class="p">;</span> <span class="p">},</span>

  <span class="nx">getIndexOfSelected</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">selected</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getIndexOfChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">selected</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">i</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-228">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-228">&#182;</a>               </div>               <p>Draw our display list.
Here we turn our DisplayObjects into text, and merge the text into
the final array of characters to display.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">draw</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">silent</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">silent</span> <span class="o">=</span> <span class="nx">silent</span> <span class="o">||</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-229">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-229">&#182;</a>               </div>               <p>Init our matrix</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">initMatrix</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-230">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-230">&#182;</a>               </div>               <p>Turn the display list into a single array of characters</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nb">Array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">displayList</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">drawDisplayListItem</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-231">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-231">&#182;</a>               </div>               <p>Insert into DOM</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">txt</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">characterGrid</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">elem</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">txt</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">silent</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">fireEvent</span><span class="p">(</span><span class="s1">&#39;canvasRefresh&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-232">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-232">&#182;</a>               </div>               <p>Given a DisplayObject, turn it into a text matrix.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">drawDisplayListItem</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">object</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="kr">char</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="kr">char</span><span class="p">,</span>
        <span class="nx">xOff</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">getX</span><span class="p">(),</span>
        <span class="nx">yOff</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">getY</span><span class="p">(),</span>
        <span class="nx">a</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">draw</span><span class="p">(),</span>
        <span class="nx">m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">characterGrid</span><span class="p">.</span><span class="nx">getArray</span><span class="p">();</span>

    <span class="nb">Array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">columnIndex</span><span class="p">,</span> <span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">Array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">rowIndex</span><span class="p">,</span> <span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">item</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">selected</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">row</span> <span class="o">=</span> <span class="s1">&#39;&lt;span class=&quot;selected&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nx">row</span> <span class="o">+</span> <span class="s1">&#39;&lt;/span&gt;&#39;</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span>
            <span class="nx">row</span> <span class="o">=</span> <span class="s1">&#39;&lt;span&gt;&#39;</span> <span class="o">+</span> <span class="nx">row</span> <span class="o">+</span> <span class="s1">&#39;&lt;/span&gt;&#39;</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">m</span><span class="p">[</span><span class="nb">Number</span><span class="p">(</span><span class="nx">yOff</span><span class="p">)</span> <span class="o">+</span> <span class="nx">columnIndex</span><span class="p">][</span><span class="nb">Number</span><span class="p">(</span><span class="nx">xOff</span><span class="p">)</span> <span class="o">+</span> <span class="nx">rowIndex</span><span class="p">]</span> <span class="o">=</span> <span class="nx">row</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-233">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-233">&#182;</a>               </div>               <p>TODO: handle exception</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="p">}</span>

      <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">);</span>

  <span class="p">},</span>

  <span class="nx">hitTest</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pt</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">hit</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">max</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">displayList</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">max</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">displayList</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">hitTest</span><span class="p">(</span><span class="nx">pt</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">hit</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">displayList</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">hit</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-234">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-234">&#182;</a>               </div>               <h2>Display List Management</h2>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">addChild</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">displayList</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">child</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">addChildAt</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-235">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-235">&#182;</a>               </div>               <p>Break the array into the left and right pieces.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">left</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">displayList</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">index</span><span class="p">),</span>
        <span class="nx">right</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">displayList</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">index</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-236">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-236">&#182;</a>               </div>               <p>Merge the left and right arrays with the new child in the middle.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">displayList</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">merge</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span> <span class="p">[</span><span class="nx">child</span><span class="p">],</span> <span class="nx">right</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">removeChild</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">displayList</span><span class="p">.</span><span class="nx">erase</span><span class="p">(</span><span class="nx">child</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">swapChildren</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">indexA</span><span class="p">,</span> <span class="nx">indexB</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">childA</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getChildAt</span><span class="p">(</span><span class="nx">indexA</span><span class="p">),</span>
        <span class="nx">childB</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getChildAt</span><span class="p">(</span><span class="nx">indexB</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">childA</span> <span class="o">&amp;&amp;</span> <span class="nx">childB</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">displayList</span><span class="p">[</span><span class="nx">indexA</span><span class="p">]</span> <span class="o">=</span> <span class="nx">childB</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">displayList</span><span class="p">[</span><span class="nx">indexB</span><span class="p">]</span> <span class="o">=</span> <span class="nx">childA</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">getChildAt</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">displayList</span><span class="p">[</span><span class="nx">index</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">displayList</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">getIndexOfChild</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">found</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">max</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">displayList</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">max</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">displayList</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="nx">child</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">found</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">found</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">removeChildAt</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">removed</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">displayList</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">removed</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">displayList</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">removed</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">selected</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">selected</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">removed</span><span class="p">;</span>

  <span class="p">},</span>

  <span class="nx">count</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">displayList</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-237">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-237">&#182;</a>               </div>               <h2>Other Canvas methods</h2>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">getText</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">redraw</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">redraw</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">txt</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">toJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class="p">{</span><span class="nx">displayList</span><span class="o">:</span><span class="p">[]};</span>
    <span class="nb">Array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">displayList</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">array</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">json</span><span class="p">.</span><span class="nx">displayList</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">());</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">json</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">fromJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">errors</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">json</span> <span class="o">!==</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">json</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">json</span><span class="p">.</span><span class="nx">displayList</span><span class="p">)</span> <span class="p">{</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">displayList</span> <span class="o">=</span> <span class="p">[];</span>

      <span class="nb">Array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">json</span><span class="p">.</span><span class="nx">displayList</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">newObj</span> <span class="o">=</span> <span class="nx">DisplayObjectFactory</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">displayList</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">newObj</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">},</span> <span class="k">this</span><span class="p">);</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Errors encountered while opening file: &#39;</span><span class="p">,</span> <span class="nx">errors</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-238">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-238">&#182;</a>               </div>               <h1>Display Object</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-239">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-239">&#182;</a>               </div>               <p>Base display object for all objects drawn into the canvas</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DisplayObject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">({</span>

  <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>

  <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;DisplayObject&#39;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-240">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-240">&#182;</a>               </div>               <p>Left coordinate.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">x</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-241">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-241">&#182;</a>               </div>               <p>Top coordinate.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">y</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-242">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-242">&#182;</a>               </div>               <p>Constructor</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">x</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">y</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">setName</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span> <span class="p">},</span>
  <span class="nx">getName</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span> <span class="p">},</span>

  <span class="nx">getX</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span> <span class="p">},</span>

  <span class="nx">getY</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span> <span class="p">},</span>

  <span class="nx">getType</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span> <span class="p">},</span>

  <span class="nx">setPosition</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">pt</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">pt</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">getPosition</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">edit</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){},</span>

  <span class="nx">refresh</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){},</span></pre></div>             </td>           </tr>                               <tr id="section-243">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-243">&#182;</a>               </div>               <p>Interface for the hitTest method.
Must test if a point 'hits' this object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">hitTest</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="s1">&#39;Display Objects must implement the hitTest method&#39;</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="s1">&#39;Display Objects must implement their own toString method&#39;</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-244">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-244">&#182;</a>               </div>               <p>Render the object's properties to json so it can be saved.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">toJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="s1">&#39;Display Objects must implement their own toJSON method&#39;</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-245">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-245">&#182;</a>               </div>               <p>Re-create the object from the json created from the toJSON method.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">fromJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="s1">&#39;Display Objects must implement their own fromJSON method&#39;</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-246">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-246">&#182;</a>               </div>               <p>Interface for the draw method.
Must return an array of characters fit for display to user.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">draw</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="s1">&#39;Display Objects must implement the hitTest method&#39;</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-247">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-247">&#182;</a>               </div>               <h1>Display Object Factory</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-248">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-248">&#182;</a>               </div>               <p>Simple factory for creating DisplayObjects from an object-map of properties.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DisplayObjectFactory</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">createDisplayObject</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">props</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">switch</span><span class="p">(</span><span class="nx">props</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>

      <span class="k">case</span> <span class="s1">&#39;Box&#39;</span><span class="o">:</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">Box</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="s1">&#39;Text&#39;</span><span class="o">:</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">Text</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>

      <span class="k">default</span><span class="o">:</span> <span class="k">throw</span> <span class="s1">&#39;Could not find display object type &quot;&#39;</span> <span class="o">+</span> <span class="nx">props</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>

      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="p">{</span><span class="nx">create</span><span class="o">:</span> <span class="nx">createDisplayObject</span><span class="p">};</span>

<span class="p">})();</span></pre></div>             </td>           </tr>                               <tr id="section-249">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-249">&#182;</a>               </div>               <h1>Box</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-250">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-250">&#182;</a>               </div>               <p>Class definition</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Box</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">({</span></pre></div>             </td>           </tr>                               <tr id="section-251">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-251">&#182;</a>               </div>               <p>Build off of the base DisplayObject</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Extends</span><span class="o">:</span> <span class="nx">DisplayObject</span><span class="p">,</span>

  <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;Box&#39;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-252">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-252">&#182;</a>               </div>               <p>Store our matrix of display information here</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">m</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-253">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-253">&#182;</a>               </div>               <p>Default options for the box.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">height</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nx">width</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="kr">char</span><span class="o">:</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-254">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-254">&#182;</a>               </div>               <p>A blankChar of <code>undefined</code> will render a transparent box.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">blankChar</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-255">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-255">&#182;</a>               </div>               <p>Should this shape be transparent of solid?</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">solid</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-256">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-256">&#182;</a>               </div>               <p>Constructor</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">width</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">height</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="kr">char</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="kr">char</span> <span class="o">||</span> <span class="s1">&#39;*&#39;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">blankChar</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">blankChar</span> <span class="o">||</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">solid</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">solid</span> <span class="o">||</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">refresh</span><span class="p">();</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-257">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-257">&#182;</a>               </div>               <p>Refresh the box. Re-creates the matrix of display info.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">refresh</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">solid</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">blankChar</span> <span class="o">=</span> <span class="nx">Utilities</span><span class="p">.</span><span class="nx">blankChar</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">blankChar</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CharacterGrid</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">blankChar</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">getWidth</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span> <span class="p">},</span>

  <span class="nx">getHeight</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span> <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-258">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-258">&#182;</a>               </div>               <p>Update an option. This will cause a refresh.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">updateOption</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">refresh</span><span class="p">();</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-259">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-259">&#182;</a>               </div>               <p>Hit Test the box given a click-point.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">hitTest</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pt</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-260">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-260">&#182;</a>               </div>               <p>Calculate the bounds of this box</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">top</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getY</span><span class="p">(),</span>
        <span class="nx">right</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getX</span><span class="p">()</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">(),</span>
        <span class="nx">bottom</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getY</span><span class="p">()</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">(),</span>
        <span class="nx">left</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getX</span><span class="p">(),</span>
        <span class="nx">hit</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-261">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-261">&#182;</a>               </div>               <p>Is the point within the bounds, inclusive?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">pt</span><span class="p">.</span><span class="nx">x</span> <span class="o">&gt;=</span> <span class="nx">left</span> <span class="o">&amp;&amp;</span> <span class="nx">pt</span><span class="p">.</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">right</span> <span class="o">&amp;&amp;</span>
        <span class="nx">pt</span><span class="p">.</span><span class="nx">y</span> <span class="o">&gt;=</span> <span class="nx">top</span> <span class="o">&amp;&amp;</span> <span class="nx">pt</span><span class="p">.</span><span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">bottom</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">hit</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">hit</span><span class="p">;</span>

  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-262">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-262">&#182;</a>               </div>               <p>Draw the box.
Will render the matrix so it's fit for displaying.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">draw</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">getArray</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-263">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-263">&#182;</a>               </div>               <p>Create the top and bottom sides</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-264">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-264">&#182;</a>               </div>               <p>Set the top characters</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="kr">char</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-265">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-265">&#182;</a>               </div>               <p>Set the bottom characters</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">a</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="kr">char</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-266">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-266">&#182;</a>               </div>               <p>Create the left and right sides</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-267">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-267">&#182;</a>               </div>               <p>Set the left-side characters</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="kr">char</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-268">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-268">&#182;</a>               </div>               <p>Set the right-side characters</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="kr">char</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-269">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-269">&#182;</a>               </div>               <p>Get the character at a specific location</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">charAt</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">getArray</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">a</span><span class="p">[</span><span class="nx">pt</span><span class="p">.</span><span class="nx">x</span><span class="p">][</span><span class="nx">pt</span><span class="p">.</span><span class="nx">y</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">&#39;{type: Box, x:&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="s1">&#39;, y:&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span>
           <span class="s1">&#39;, width:&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">+</span> <span class="s1">&#39;, height:&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">toJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span>
        <span class="nx">name</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
        <span class="nx">x</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span>
        <span class="nx">y</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span>
        <span class="nx">width</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span>
        <span class="nx">height</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span>
        <span class="kr">char</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="kr">char</span><span class="p">,</span>
        <span class="nx">solid</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">solid</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="nx">json</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">fromJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">initialize</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-270">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-270">&#182;</a>               </div>               <p>This is experimental code here...nothing to see...</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/* Utilities.enhanceWithGettersAndSetters(Box.prototype); */</span></pre></div>             </td>           </tr>                               <tr id="section-271">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-271">&#182;</a>               </div>               <h1>Text Display Object</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-272">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-272">&#182;</a>               </div>               <p>A basic text container</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Text</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">({</span></pre></div>             </td>           </tr>                               <tr id="section-273">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-273">&#182;</a>               </div>               <p>Build off of the base DisplayObject</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Extends</span><span class="o">:</span> <span class="nx">DisplayObject</span><span class="p">,</span>

  <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;Text&#39;</span><span class="p">,</span>

  <span class="nx">txt</span><span class="o">:</span> <span class="s1">&#39;New Text Box&#39;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-274">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-274">&#182;</a>               </div>               <p>Constructor</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">txt</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">txt</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">txt</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">setText</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">txt</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">getText</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">txt</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-275">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-275">&#182;</a>               </div>               <p>Hit Test the box given a click-point.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">hitTest</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pt</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-276">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-276">&#182;</a>               </div>               <p>Calculate the bounds of this box</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">top</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getY</span><span class="p">(),</span>
        <span class="nx">right</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getX</span><span class="p">())</span> <span class="o">+</span> <span class="nb">Number</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">txt</span><span class="p">.</span><span class="nx">length</span><span class="p">),</span>
        <span class="nx">bottom</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getY</span><span class="p">(),</span>
        <span class="nx">left</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getX</span><span class="p">(),</span>
        <span class="nx">hit</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">contentArray</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">draw</span><span class="p">();</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">contentArray</span><span class="p">[</span><span class="nx">pt</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">top</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">contentArray</span><span class="p">[</span><span class="nx">pt</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">top</span><span class="p">][</span><span class="nx">pt</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">left</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">hit</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">hit</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">draw</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">txt</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\n\r?/g</span><span class="p">,</span> <span class="s1">&#39;&lt;br /&gt;&#39;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;&lt;br /&gt;&quot;</span><span class="p">),</span>
        <span class="nx">finalArray</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">h</span> <span class="o">&lt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">h</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">row</span> <span class="o">=</span> <span class="nx">a</span><span class="p">[</span><span class="nx">h</span><span class="p">];</span>

      <span class="nx">finalArray</span><span class="p">[</span><span class="nx">h</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>

      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">w</span> <span class="o">&lt;</span> <span class="nx">row</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">w</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">finalArray</span><span class="p">[</span><span class="nx">h</span><span class="p">][</span><span class="nx">w</span><span class="p">]</span> <span class="o">=</span> <span class="nx">row</span><span class="p">[</span><span class="nx">w</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39; &#39;</span> <span class="o">?</span> <span class="s1">&#39;&amp;nbsp;&#39;</span> <span class="o">:</span> <span class="nx">row</span><span class="p">[</span><span class="nx">w</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">finalArray</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">&#39;{type: Text, value: &quot;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">txt</span> <span class="o">+</span> <span class="s1">&#39;&quot;}&#39;</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">toJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span>
        <span class="nx">name</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
        <span class="nx">x</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span>
        <span class="nx">y</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span>
        <span class="nx">txt</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">txt</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">,</span> <span class="s1">&#39;\\n&#39;</span><span class="p">)</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="nx">json</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">fromJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">initialize</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">});</span>

<span class="cm">/*</span>
<span class="cm">---</span>
<span class="cm">description: LightFace</span>

<span class="cm">license: MIT-style</span>

<span class="cm">authors:</span>
<span class="cm">- David Walsh (http://davidwalsh.name)</span>

<span class="cm">requires:</span>
<span class="cm">- core/1.2.1: &#39;*&#39;</span>

<span class="cm">provides: [LightFace]</span>

<span class="cm">...</span>
<span class="cm">*/</span>

<span class="kd">var</span> <span class="nx">LightFace</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">({</span>
	
	<span class="nx">Implements</span><span class="o">:</span> <span class="p">[</span><span class="nx">Options</span><span class="p">,</span><span class="nx">Events</span><span class="p">],</span>
	
	<span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
		<span class="nx">width</span><span class="o">:</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
		<span class="nx">height</span><span class="o">:</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
		<span class="nx">draggable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
		<span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
		<span class="nx">buttons</span><span class="o">:</span> <span class="p">[],</span>
		<span class="nx">fadeDelay</span><span class="o">:</span> <span class="mi">400</span><span class="p">,</span>
		<span class="nx">fadeDuration</span><span class="o">:</span> <span class="mi">400</span><span class="p">,</span>
		<span class="nx">keys</span><span class="o">:</span> <span class="p">{</span> 
			<span class="nx">esc</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span> <span class="p">}</span> 
		<span class="p">},</span>
		<span class="nx">content</span><span class="o">:</span> <span class="s1">&#39;&lt;p&gt;Message not specified.&lt;/p&gt;&#39;</span><span class="p">,</span>
		<span class="nx">zIndex</span><span class="o">:</span> <span class="mi">9001</span><span class="p">,</span>
		<span class="nx">pad</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span>
		<span class="nx">overlayAll</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
		<span class="nx">constrain</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
		<span class="nx">resetOnScroll</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
		<span class="nx">baseClass</span><span class="o">:</span> <span class="s1">&#39;lightface&#39;</span><span class="p">,</span>
		<span class="nx">errorMessage</span><span class="o">:</span> <span class="s1">&#39;&lt;p&gt;The requested file could not be found.&lt;/p&gt;&#39;</span><span class="cm">/*,</span>
<span class="cm">		onOpen: $empty,</span>
<span class="cm">		onClose: $empty,</span>
<span class="cm">		onFade: $empty,</span>
<span class="cm">		onUnfade: $empty,</span>
<span class="cm">		onComplete: $empty,</span>
<span class="cm">		onRequest: $empty,</span>
<span class="cm">		onSuccess: $empty,</span>
<span class="cm">		onFailure: $empty</span>
<span class="cm">		*/</span>
	<span class="p">},</span>
	
	
	<span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">setOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">buttons</span> <span class="o">=</span> <span class="p">{};</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">resizeOnOpen</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">ie6</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">maxHeight</span> <span class="o">==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">;</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">draw</span><span class="p">();</span>
	<span class="p">},</span>
	
	<span class="nx">draw</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		</pre></div>             </td>           </tr>                               <tr id="section-277">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-277">&#182;</a>               </div>               <p>create main box</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">box</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">,{</span>
			<span class="s1">&#39;class&#39;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">baseClass</span><span class="p">,</span>
			<span class="nx">styles</span><span class="o">:</span> <span class="p">{</span>
				<span class="s1">&#39;z-index&#39;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">zIndex</span><span class="p">,</span>
				<span class="nx">opacity</span><span class="o">:</span> <span class="mi">0</span>
			<span class="p">},</span>
			<span class="nx">tween</span><span class="o">:</span> <span class="p">{</span>
				<span class="nx">duration</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">fadeDuration</span><span class="p">,</span>
				<span class="nx">onComplete</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
					<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">box</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">this</span><span class="p">.</span><span class="nx">box</span><span class="p">.</span><span class="nx">setStyles</span><span class="p">({</span> <span class="nx">top</span><span class="o">:</span> <span class="o">-</span><span class="mi">9000</span><span class="p">,</span> <span class="nx">left</span><span class="o">:</span> <span class="o">-</span><span class="mi">9000</span> <span class="p">});</span>
					<span class="p">}</span>
				<span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}).</span><span class="nx">inject</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span><span class="s1">&#39;bottom&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-278">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-278">&#182;</a>               </div>               <p>draw rows and cells;  use native JS to avoid IE7 and I6 offsetWidth and offsetHeight issues</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">var</span> <span class="nx">verts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="s1">&#39;bottom&#39;</span><span class="p">],</span> <span class="nx">hors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Left&#39;</span><span class="p">,</span><span class="s1">&#39;Center&#39;</span><span class="p">,</span><span class="s1">&#39;Right&#39;</span><span class="p">],</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">verts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">row</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">box</span><span class="p">.</span><span class="nx">insertRow</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
			<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">cssClass</span> <span class="o">=</span> <span class="nx">verts</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span> <span class="o">+</span> <span class="nx">hors</span><span class="p">[</span><span class="nx">y</span><span class="p">],</span> <span class="nx">cell</span> <span class="o">=</span> <span class="nx">row</span><span class="p">.</span><span class="nx">insertCell</span><span class="p">(</span><span class="nx">y</span><span class="p">);</span>
				<span class="nx">cell</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="nx">cssClass</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="nx">cssClass</span> <span class="o">==</span> <span class="s1">&#39;centerCenter&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">contentBox</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,{</span>
						<span class="s1">&#39;class&#39;</span><span class="o">:</span> <span class="s1">&#39;lightfaceContent&#39;</span><span class="p">,</span>
						<span class="nx">styles</span><span class="o">:</span> <span class="p">{</span>
							<span class="nx">width</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">width</span>
						<span class="p">}</span>
					<span class="p">});</span>
					<span class="nx">cell</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">contentBox</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="nb">document</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="nx">cell</span><span class="p">).</span><span class="nx">setStyle</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">,</span><span class="mf">0.4</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		</pre></div>             </td>           </tr>                               <tr id="section-279">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-279">&#182;</a>               </div>               <p>draw title</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">title</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">(</span><span class="s1">&#39;h2&#39;</span><span class="p">,{</span>
				<span class="s1">&#39;class&#39;</span><span class="o">:</span> <span class="s1">&#39;lightfaceTitle&#39;</span><span class="p">,</span>
				<span class="nx">html</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">title</span>
			<span class="p">}).</span><span class="nx">inject</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">contentBox</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">draggable</span> <span class="o">&amp;&amp;</span> <span class="nb">window</span><span class="p">[</span><span class="s1">&#39;Drag&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">draggable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
				<span class="k">new</span> <span class="nx">Drag</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">box</span><span class="p">,{</span> <span class="nx">handle</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">title</span> <span class="p">});</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">title</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;lightfaceDraggable&#39;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		</pre></div>             </td>           </tr>                               <tr id="section-280">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-280">&#182;</a>               </div>               <p>draw message box</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">messageBox</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,{</span>
			<span class="s1">&#39;class&#39;</span><span class="o">:</span> <span class="s1">&#39;lightfaceMessageBox&#39;</span><span class="p">,</span>
			<span class="nx">html</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">content</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
			<span class="nx">styles</span><span class="o">:</span> <span class="p">{</span>
				<span class="nx">height</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">height</span>
			<span class="p">}</span>
		<span class="p">}).</span><span class="nx">inject</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">contentBox</span><span class="p">);</span>
		</pre></div>             </td>           </tr>                               <tr id="section-281">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-281">&#182;</a>               </div>               <p>button container</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">footer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,{</span>
			<span class="s1">&#39;class&#39;</span><span class="o">:</span> <span class="s1">&#39;lightfaceFooter&#39;</span><span class="p">,</span>
			<span class="nx">styles</span><span class="o">:</span> <span class="p">{</span>
				<span class="nx">display</span><span class="o">:</span> <span class="s1">&#39;none&#39;</span>
			<span class="p">}</span>
		<span class="p">}).</span><span class="nx">inject</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">contentBox</span><span class="p">);</span>
		</pre></div>             </td>           </tr>                               <tr id="section-282">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-282">&#182;</a>               </div>               <p>draw overlay</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">overlay</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,{</span>
			<span class="nx">html</span><span class="o">:</span> <span class="s1">&#39;&amp;nbsp;&#39;</span><span class="p">,</span>
			<span class="nx">styles</span><span class="o">:</span> <span class="p">{</span>
				<span class="nx">opacity</span><span class="o">:</span> <span class="mi">0</span>
			<span class="p">},</span>
			<span class="s1">&#39;class&#39;</span><span class="o">:</span> <span class="s1">&#39;lightfaceOverlay&#39;</span><span class="p">,</span>
			<span class="nx">tween</span><span class="o">:</span> <span class="p">{</span>
				<span class="nx">link</span><span class="o">:</span> <span class="s1">&#39;chain&#39;</span><span class="p">,</span>
				<span class="nx">duration</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">fadeDuration</span><span class="p">,</span>
				<span class="nx">onComplete</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
					<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">overlay</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">box</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
				<span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}).</span><span class="nx">inject</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">contentBox</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">overlayAll</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">overlay</span><span class="p">.</span><span class="nx">setStyle</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">,(</span><span class="k">this</span><span class="p">.</span><span class="nx">title</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">title</span><span class="p">.</span><span class="nx">getSize</span><span class="p">().</span><span class="nx">y</span> <span class="o">-</span> <span class="mi">1</span><span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
		<span class="p">}</span>
		</pre></div>             </td>           </tr>                               <tr id="section-283">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-283">&#182;</a>               </div>               <p>create initial buttons</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">buttons</span> <span class="o">=</span> <span class="p">[];</span>
		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">buttons</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">buttons</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">button</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">addButton</span><span class="p">(</span><span class="nx">button</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span><span class="nx">button</span><span class="p">.</span><span class="nx">event</span><span class="p">,</span><span class="nx">button</span><span class="p">.</span><span class="nx">color</span><span class="p">);</span>
			<span class="p">},</span><span class="k">this</span><span class="p">);</span>
		<span class="p">}</span>
		</pre></div>             </td>           </tr>                               <tr id="section-284">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-284">&#182;</a>               </div>               <p>focus node</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">focusNode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">box</span><span class="p">;</span>
		
		<span class="k">return</span> <span class="k">this</span><span class="p">;</span>
	<span class="p">},</span>
	</pre></div>             </td>           </tr>                               <tr id="section-285">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-285">&#182;</a>               </div>               <p>Manage buttons</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">addButton</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">clickEvent</span><span class="p">,</span><span class="nx">color</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">footer</span><span class="p">.</span><span class="nx">setStyle</span><span class="p">(</span><span class="s1">&#39;display&#39;</span><span class="p">,</span><span class="s1">&#39;block&#39;</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">focusClass</span> <span class="o">=</span> <span class="s1">&#39;lightfacefocus&#39;</span> <span class="o">+</span> <span class="nx">color</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">label</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,{</span>
			<span class="s1">&#39;class&#39;</span><span class="o">:</span> <span class="nx">color</span> <span class="o">?</span> <span class="s1">&#39;lightface&#39;</span> <span class="o">+</span> <span class="nx">color</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
			<span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
				<span class="nx">mousedown</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
					<span class="k">if</span><span class="p">(</span><span class="nx">color</span><span class="p">)</span> <span class="p">{</span>
						<span class="nx">label</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="nx">focusClass</span><span class="p">);</span>
						<span class="kd">var</span> <span class="nx">ev</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
							<span class="nx">label</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="nx">focusClass</span><span class="p">);</span>
							<span class="nb">document</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">).</span><span class="nx">removeEvent</span><span class="p">(</span><span class="s1">&#39;mouseup&#39;</span><span class="p">,</span><span class="nx">ev</span><span class="p">);</span>
						<span class="p">};</span>
						<span class="nb">document</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">).</span><span class="nx">addEvent</span><span class="p">(</span><span class="s1">&#39;mouseup&#39;</span><span class="p">,</span><span class="nx">ev</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">});</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">buttons</span><span class="p">[</span><span class="nx">title</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nx">Element</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,{</span>
			<span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;button&#39;</span><span class="p">,</span>
			<span class="nx">value</span><span class="o">:</span> <span class="nx">title</span><span class="p">,</span>
			<span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
				<span class="nx">click</span><span class="o">:</span> <span class="p">(</span><span class="nx">clickEvent</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">close</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}).</span><span class="nx">inject</span><span class="p">(</span><span class="nx">label</span><span class="p">));</span>
		<span class="nx">label</span><span class="p">.</span><span class="nx">inject</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">footer</span><span class="p">);</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">;</span>
	<span class="p">},</span>
	<span class="nx">showButton</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">buttons</span><span class="p">[</span><span class="nx">title</span><span class="p">])</span> <span class="k">this</span><span class="p">.</span><span class="nx">buttons</span><span class="p">[</span><span class="nx">title</span><span class="p">].</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;hiddenButton&#39;</span><span class="p">);</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">buttons</span><span class="p">[</span><span class="nx">title</span><span class="p">];</span>
	<span class="p">},</span>
	<span class="nx">hideButton</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">buttons</span><span class="p">[</span><span class="nx">title</span><span class="p">])</span> <span class="k">this</span><span class="p">.</span><span class="nx">buttons</span><span class="p">[</span><span class="nx">title</span><span class="p">].</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;hiddenButton&#39;</span><span class="p">);</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">buttons</span><span class="p">[</span><span class="nx">title</span><span class="p">];</span>
	<span class="p">},</span>
	</pre></div>             </td>           </tr>                               <tr id="section-286">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-286">&#182;</a>               </div>               <p>Open and close box</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">close</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fast</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isOpen</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">box</span><span class="p">[</span><span class="nx">fast</span> <span class="o">?</span> <span class="s1">&#39;setStyles&#39;</span> <span class="o">:</span> <span class="s1">&#39;tween&#39;</span><span class="p">](</span><span class="s1">&#39;opacity&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">fireEvent</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">_detachEvents</span><span class="p">();</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">isOpen</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">;</span>
	<span class="p">},</span>
	
	<span class="nx">open</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fast</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isOpen</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">box</span><span class="p">[</span><span class="nx">fast</span> <span class="o">?</span> <span class="s1">&#39;setStyles&#39;</span> <span class="o">:</span> <span class="s1">&#39;tween&#39;</span><span class="p">](</span><span class="s1">&#39;opacity&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">resizeOnOpen</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">_resize</span><span class="p">();</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">fireEvent</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">_attachEvents</span><span class="p">();</span>
			<span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">_setFocus</span><span class="p">();</span>
			<span class="p">}).</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">delay</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">fadeDuration</span> <span class="o">+</span> <span class="mi">10</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">isOpen</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">;</span>
	<span class="p">},</span>
	
	<span class="nx">_setFocus</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">focusNode</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;tabIndex&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">focusNode</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
	<span class="p">},</span>
	</pre></div>             </td>           </tr>                               <tr id="section-287">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-287">&#182;</a>               </div>               <p>Show and hide overlay</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">fade</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fade</span><span class="p">,</span><span class="nx">delay</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">_ie6Size</span><span class="p">();</span>
		<span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">overlay</span><span class="p">.</span><span class="nx">setStyle</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">,</span><span class="nx">fade</span> <span class="o">||</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)).</span><span class="nx">delay</span><span class="p">(</span><span class="nx">delay</span> <span class="o">||</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">fireEvent</span><span class="p">(</span><span class="s1">&#39;fade&#39;</span><span class="p">);</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">;</span>
	<span class="p">},</span>
	<span class="nx">unfade</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">delay</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">overlay</span><span class="p">.</span><span class="nx">fade</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)).</span><span class="nx">delay</span><span class="p">(</span><span class="nx">delay</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">fadeDelay</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">fireEvent</span><span class="p">(</span><span class="s1">&#39;unfade&#39;</span><span class="p">);</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">;</span>
	<span class="p">},</span>
	<span class="nx">_ie6Size</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ie6</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">size</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">contentBox</span><span class="p">.</span><span class="nx">getSize</span><span class="p">();</span>
			<span class="kd">var</span> <span class="nx">titleHeight</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">overlayAll</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">title</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">title</span><span class="p">.</span><span class="nx">getSize</span><span class="p">().</span><span class="nx">y</span><span class="p">;</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">overlay</span><span class="p">.</span><span class="nx">setStyles</span><span class="p">({</span>
				<span class="nx">height</span><span class="o">:</span> <span class="nx">size</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">titleHeight</span><span class="p">,</span>
				<span class="nx">width</span><span class="o">:</span> <span class="nx">size</span><span class="p">.</span><span class="nx">x</span>
			<span class="p">});</span>
		<span class="p">}</span>
	<span class="p">},</span>
	</pre></div>             </td>           </tr>                               <tr id="section-288">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-288">&#182;</a>               </div>               <p>Loads content</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">load</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">content</span><span class="p">,</span><span class="nx">title</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">messageBox</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;html&#39;</span><span class="p">,</span><span class="nx">content</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">title</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">title</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">title</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;html&#39;</span><span class="p">,</span><span class="nx">title</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">fireEvent</span><span class="p">(</span><span class="s1">&#39;complete&#39;</span><span class="p">);</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">;</span>
	<span class="p">},</span>
	</pre></div>             </td>           </tr>                               <tr id="section-289">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-289">&#182;</a>               </div>               <p>Attaches events when opened</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">_attachEvents</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">keyEvent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
			<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">keys</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">key</span><span class="p">])</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">keys</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">key</span><span class="p">].</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
		<span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">focusNode</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span><span class="s1">&#39;keyup&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">keyEvent</span><span class="p">);</span>
		
		<span class="k">this</span><span class="p">.</span><span class="nx">resizeEvent</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">constrain</span> <span class="o">?</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> 
			<span class="k">this</span><span class="p">.</span><span class="nx">_resize</span><span class="p">();</span> 
		<span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> 
			<span class="k">this</span><span class="p">.</span><span class="nx">_position</span><span class="p">();</span> 
		<span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
		<span class="nb">window</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span><span class="s1">&#39;resize&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">resizeEvent</span><span class="p">);</span>
		
		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">resetOnScroll</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">scrollEvent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">_position</span><span class="p">();</span>
			<span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
			<span class="nb">window</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span><span class="s1">&#39;scroll&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">scrollEvent</span><span class="p">);</span>
		<span class="p">}</span>
		
		<span class="k">return</span> <span class="k">this</span><span class="p">;</span>
	<span class="p">},</span>
	</pre></div>             </td>           </tr>                               <tr id="section-290">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-290">&#182;</a>               </div>               <p>Detaches events upon close</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">_detachEvents</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">focusNode</span><span class="p">.</span><span class="nx">removeEvent</span><span class="p">(</span><span class="s1">&#39;keyup&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">keyEvent</span><span class="p">);</span>
		<span class="nb">window</span><span class="p">.</span><span class="nx">removeEvent</span><span class="p">(</span><span class="s1">&#39;resize&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">resizeEvent</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scrollEvent</span><span class="p">)</span> <span class="nb">window</span><span class="p">.</span><span class="nx">removeEvent</span><span class="p">(</span><span class="s1">&#39;scroll&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">scrollEvent</span><span class="p">);</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">;</span>
	<span class="p">},</span>
	</pre></div>             </td>           </tr>                               <tr id="section-291">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-291">&#182;</a>               </div>               <p>Repositions the box</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">_position</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">windowSize</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">getSize</span><span class="p">(),</span> 
			<span class="nx">scrollSize</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">getScroll</span><span class="p">(),</span> 
			<span class="nx">boxSize</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">box</span><span class="p">.</span><span class="nx">getSize</span><span class="p">();</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">box</span><span class="p">.</span><span class="nx">setStyles</span><span class="p">({</span>
			<span class="nx">left</span><span class="o">:</span> <span class="nx">scrollSize</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="p">((</span><span class="nx">windowSize</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">boxSize</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
			<span class="nx">top</span><span class="o">:</span> <span class="nx">scrollSize</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="p">((</span><span class="nx">windowSize</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">boxSize</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
		<span class="p">});</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">_ie6Size</span><span class="p">();</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">;</span>
	<span class="p">},</span>
	</pre></div>             </td>           </tr>                               <tr id="section-292">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-292">&#182;</a>               </div>               <p>Resizes the box, then positions it</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">_resize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">height</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">height</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-293">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-293">&#182;</a>               </div>               <p>get the height of the content box</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="kd">var</span> <span class="nx">max</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">getSize</span><span class="p">().</span><span class="nx">y</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">pad</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">contentBox</span><span class="p">.</span><span class="nx">getSize</span><span class="p">().</span><span class="nx">y</span> <span class="o">&gt;</span> <span class="nx">max</span><span class="p">)</span> <span class="nx">height</span> <span class="o">=</span> <span class="nx">max</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">messageBox</span><span class="p">.</span><span class="nx">setStyle</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span><span class="nx">height</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">_position</span><span class="p">();</span>
	<span class="p">},</span>
	</pre></div>             </td>           </tr>                               <tr id="section-294">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-294">&#182;</a>               </div>               <p>Expose message box</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">toElement</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">messageBox</span><span class="p">;</span>
	<span class="p">},</span>
	</pre></div>             </td>           </tr>                               <tr id="section-295">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-295">&#182;</a>               </div>               <p>Expose entire modal box</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">getBox</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">box</span><span class="p">;</span>
	<span class="p">},</span>
	</pre></div>             </td>           </tr>                               <tr id="section-296">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-296">&#182;</a>               </div>               <p>Cleanup</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">destroy</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">_detachEvents</span><span class="p">();</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">buttons</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">button</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">button</span><span class="p">.</span><span class="nx">removeEvents</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">);</span>
		<span class="p">});</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">box</span><span class="p">.</span><span class="nx">dispose</span><span class="p">();</span>
		<span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">box</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">});</span>

<span class="cm">/*</span>
<span class="cm">---</span>
<span class="cm">description:     LightFace.Static</span>

<span class="cm">authors:</span>
<span class="cm">  - David Walsh (http://davidwalsh.name)</span>

<span class="cm">license:</span>
<span class="cm">  - MIT-style license</span>

<span class="cm">requires:</span>
<span class="cm">  core/1.2.1:   &#39;*&#39;</span>

<span class="cm">provides:</span>
<span class="cm">  - LightFace.Static</span>
<span class="cm">...</span>
<span class="cm">*/</span>
<span class="nx">LightFace</span><span class="p">.</span><span class="nx">Static</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">({</span>
	<span class="nx">Extends</span><span class="o">:</span> <span class="nx">LightFace</span><span class="p">,</span>
	<span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
		<span class="nx">offsets</span><span class="o">:</span> <span class="p">{</span>
			<span class="nx">x</span><span class="o">:</span> <span class="mi">20</span><span class="p">,</span>
			<span class="nx">y</span><span class="o">:</span> <span class="mi">20</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="nx">open</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fast</span><span class="p">,</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">(</span><span class="nx">fast</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">_position</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">);</span>
	<span class="p">},</span>
	<span class="nx">_position</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">x</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">box</span><span class="p">.</span><span class="nx">setStyles</span><span class="p">({</span>
			<span class="nx">top</span><span class="o">:</span> <span class="nx">y</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">offsets</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span>
			<span class="nx">left</span><span class="o">:</span> <span class="nx">x</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">offsets</span><span class="p">.</span><span class="nx">x</span>
		<span class="p">});</span>
	<span class="p">}</span>
<span class="p">});</span>

<span class="cm">/*</span>
<span class="cm">---</span>
<span class="cm">description: A cross browser persistent storgae API</span>

<span class="cm">license: MIT-style</span>

<span class="cm">authors:</span>
<span class="cm">- Arieh Glazer</span>

<span class="cm">requires:</span>
<span class="cm">- core/1.2.4 : [Core,Class,Class.Extras,Cookie]</span>

<span class="cm">provides: [LocalStorage]</span>

<span class="cm">...</span>
<span class="cm">*/</span>
<span class="cm">/*!</span>
<span class="cm">Copyright (c) 2010 Arieh Glazer</span>

<span class="cm">Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="cm">of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="cm">in the Software without restriction, including without limitation the rights</span>
<span class="cm">to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="cm">copies of the Software, and to permit persons to whom the Software is</span>
<span class="cm">furnished to do so, subject to the following conditions:</span>

<span class="cm">The above copyright notice and this permission notice shall be included in</span>
<span class="cm">all copies or substantial portions of the Software.</span>

<span class="cm">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="cm">AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm">LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="cm">OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN</span>
<span class="cm">THE SOFTWARE </span>
<span class="cm">*/</span>
<span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span><span class="nb">window</span><span class="p">,</span><span class="nx">undef</span><span class="p">){</span>

<span class="nb">window</span><span class="p">[</span><span class="s1">&#39;LocalStorage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">({</span>
    <span class="nx">Implements</span> <span class="o">:</span> <span class="p">[</span><span class="nx">Options</span><span class="p">]</span>
    <span class="p">,</span> <span class="nx">options</span> <span class="o">:</span> <span class="p">{</span>
          <span class="nx">path</span> <span class="o">:</span> <span class="s1">&#39;*&#39;</span>
        <span class="p">,</span> <span class="nx">name</span> <span class="o">:</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hostname</span>
        <span class="p">,</span> <span class="nx">duration</span> <span class="o">:</span> <span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">30</span>
        <span class="p">,</span> <span class="nx">debug</span> <span class="o">:</span> <span class="kc">false</span>
    <span class="p">}</span>
    <span class="p">,</span> <span class="nx">storage</span> <span class="o">:</span> <span class="kc">null</span>
    <span class="p">,</span> <span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">){</span>
         <span class="kd">var</span> <span class="nx">$this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
         
         <span class="k">this</span><span class="p">.</span><span class="nx">setOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
         
         <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">){</span> <span class="c1">//HTML5 storage</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">debug</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;using localStorage&#39;</span><span class="p">)</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">storage</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">;</span>
         <span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">Browser</span><span class="p">.</span><span class="nx">Engine</span><span class="p">.</span><span class="nx">trident</span><span class="p">){</span> <span class="c1">//IE &lt; 8</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">debug</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;using behavior Storage&#39;</span><span class="p">);</span>
            	<span class="k">this</span><span class="p">.</span><span class="nx">storage</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
                    <span class="kd">var</span> <span class="nx">storage</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;span&quot;</span><span class="p">);</span>
                    <span class="nx">storage</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">behavior</span> <span class="o">=</span> <span class="s2">&quot;url(#default#userData)&quot;</span><span class="p">;</span>
                    <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">).</span><span class="nx">adopt</span><span class="p">(</span><span class="nx">storage</span><span class="p">);</span>  
                    <span class="nx">storage</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">$this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
                    
                    <span class="k">return</span> <span class="p">{</span>
                        <span class="nx">setItem</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="nx">value</span><span class="p">){</span>
                            <span class="nx">storage</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="nx">value</span><span class="p">);</span>
                            <span class="nx">storage</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">$this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="p">,</span> <span class="nx">getItem</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">){</span>
                            <span class="k">return</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="p">,</span> <span class="nx">removeItem</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">){</span>
                            <span class="nx">storage</span><span class="p">.</span><span class="nx">removeAttribute</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
                            <span class="nx">storage</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">$this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">};</span>
                <span class="p">})();</span>
         <span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">globalStorage</span><span class="p">){</span> <span class="c1">//FF&lt;3.5</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">debug</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;using globalStorage&#39;</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">storage</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
                <span class="nx">storage</span> <span class="o">=</span> <span class="nx">globalStorage</span><span class="p">[</span><span class="nx">$this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">name</span><span class="p">];</span>
                <span class="k">return</span> <span class="p">{</span>
                        <span class="nx">setItem</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="nx">value</span><span class="p">){</span>
                            <span class="nx">storage</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="p">,</span> <span class="nx">getItem</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">){</span>
                            <span class="k">return</span> <span class="nx">storage</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="p">,</span> <span class="nx">removeItem</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">){</span>
                            <span class="k">delete</span><span class="p">(</span><span class="nx">storage</span><span class="p">[</span><span class="nx">name</span><span class="p">]);</span>
                        <span class="p">}</span>
                    <span class="p">};</span>
            <span class="p">})();</span>
         <span class="p">}</span><span class="k">else</span><span class="p">{</span> <span class="c1">//All others</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">debug</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;using cookies&#39;</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">storage</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
                <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span><span class="p">{</span>
                    <span class="nx">path</span> <span class="o">:</span> <span class="nx">$this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">path</span>
                    <span class="p">,</span> <span class="nx">duration</span> <span class="o">:</span> <span class="nx">$this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">duration</span>
                <span class="p">};</span>
                
                <span class="k">return</span> <span class="p">{</span>
                        <span class="nx">setItem</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="nx">value</span><span class="p">){</span>
                             <span class="nx">Cookie</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="nx">value</span><span class="p">,</span><span class="nx">options</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="p">,</span> <span class="nx">getItem</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">){</span>
                             <span class="k">return</span> <span class="nx">Cookie</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="p">,</span> <span class="nx">removeItem</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">){</span>
                             <span class="nx">Cookie</span><span class="p">.</span><span class="nx">dispose</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">};</span>
            <span class="p">})();</span>
         <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">set</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="nx">value</span><span class="p">){</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">storage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="nx">value</span><span class="p">));</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">,</span> <span class="nx">get</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">){</span>
        
        <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">storage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="nx">name</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="p">,</span> <span class="nx">remove</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">){</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">storage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="p">})(</span><span class="nb">document</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="k">this</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">---</span>
<span class="cm">description: A cross browser persistent file storage API</span>

<span class="cm">license: MIT-style</span>

<span class="cm">authors:</span>
<span class="cm">- Jon Beebe (somethingkindawierd@gmail.com)</span>

<span class="cm">requires:</span>
<span class="cm">- core/1.2.4 : [Core,Class,Class.Extras,Cookie,LocalStorage]</span>

<span class="cm">provides: [LocalFileStorage]</span>

<span class="cm">...</span>
<span class="cm">*/</span>
<span class="cm">/*!</span>
<span class="cm">Copyright (c) 2011 Jon Beebe (somethingkindawierd@gmail.com)</span>

<span class="cm">Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="cm">of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="cm">in the Software without restriction, including without limitation the rights</span>
<span class="cm">to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="cm">copies of the Software, and to permit persons to whom the Software is</span>
<span class="cm">furnished to do so, subject to the following conditions:</span>

<span class="cm">The above copyright notice and this permission notice shall be included in</span>
<span class="cm">all copies or substantial portions of the Software.</span>

<span class="cm">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="cm">AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm">LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="cm">OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN</span>
<span class="cm">THE SOFTWARE</span>
<span class="cm">*/</span>
<span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span><span class="nb">window</span><span class="p">,</span><span class="nx">undef</span><span class="p">){</span>

<span class="nb">window</span><span class="p">[</span><span class="s1">&#39;LocalFileStorage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">({</span>

    <span class="nx">Implements</span> <span class="o">:</span> <span class="p">[</span><span class="nx">Options</span><span class="p">],</span>

    <span class="nx">Extends</span><span class="o">:</span> <span class="nx">LocalStorage</span><span class="p">,</span>

    <span class="nx">options</span><span class="o">:</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-297">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-297">&#182;</a>               </div>               <p>Default namespace for all files</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">namespace</span><span class="o">:</span> <span class="s1">&#39;lfs&#39;</span><span class="p">,</span>
      <span class="nx">fileArrayName</span><span class="o">:</span> <span class="s1">&#39;__files__&#39;</span>
    <span class="p">},</span>

    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">getList</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">namespace</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">fileArrayName</span><span class="p">)</span> <span class="o">||</span> <span class="p">[];</span>
    <span class="p">},</span>

    <span class="nx">save</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">contents</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-298">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-298">&#182;</a>               </div>               <p>Store the file in local storage</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">namespace</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">filename</span><span class="p">,</span> <span class="nx">contents</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-299">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-299">&#182;</a>               </div>               <p>Record the filename in our file array</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">files</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getList</span><span class="p">();</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">files</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">filename</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">files</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">filename</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">namespace</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">fileArrayName</span><span class="p">,</span> <span class="nx">files</span><span class="p">);</span>
      <span class="p">}</span>

    <span class="p">},</span>

    <span class="nx">read</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-300">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-300">&#182;</a>               </div>               <p>Read the file from local storage</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">namespace</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">filename</span><span class="p">);</span>

    <span class="p">},</span>

    <span class="nx">remove</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-301">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-301">&#182;</a>               </div>               <p>Remove file from local storage</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">namespace</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">filename</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-302">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-302">&#182;</a>               </div>               <p>Remove file from our file array</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">files</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getList</span><span class="p">();</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">files</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">filename</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">files</span><span class="p">.</span><span class="nx">erase</span><span class="p">(</span><span class="nx">filename</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">namespace</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">fileArrayName</span><span class="p">,</span> <span class="nx">files</span><span class="p">);</span>
      <span class="p">}</span>

    <span class="p">}</span>

<span class="p">});</span>

<span class="p">})(</span><span class="nb">document</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="k">this</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">---</span>

<span class="cm">name: Touch</span>
<span class="cm">version: 0.1</span>
<span class="cm">description: Simple drag implementation that works with standard-sized browsers and hooks with mobile safari touch events.</span>
<span class="cm">license: MooTools MIT-Style License (http://mootools.net/license.txt)</span>
<span class="cm">copyright: Valerio Proietti (http://mad4milk.net)</span>
<span class="cm">authors: Valerio Proietti (http://mad4milk.net)</span>
<span class="cm">requires: Core/1.2.4: *</span>
<span class="cm">provides: Touch</span>

<span class="cm">...</span>
<span class="cm">*/</span>

<span class="kd">var</span> <span class="nx">Touch</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">({</span>

	<span class="nx">Implements</span><span class="o">:</span> <span class="nx">Events</span><span class="p">,</span>

	<span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">){</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">element</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>

		<span class="k">this</span><span class="p">.</span><span class="nx">bound</span> <span class="o">=</span> <span class="p">{</span>
			<span class="nx">start</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span>
			<span class="nx">move</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">move</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span>
			<span class="nx">end</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
		<span class="p">};</span>

		<span class="k">if</span> <span class="p">(</span><span class="nx">Browser</span><span class="p">.</span><span class="nx">Platform</span><span class="p">.</span><span class="nx">ipod</span><span class="p">){</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">;</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">startEvent</span> <span class="o">=</span> <span class="s1">&#39;touchstart&#39;</span><span class="p">;</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">endEvent</span> <span class="o">=</span> <span class="s1">&#39;touchend&#39;</span><span class="p">;</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">moveEvent</span> <span class="o">=</span> <span class="s1">&#39;touchmove&#39;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="nb">document</span><span class="p">;</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">startEvent</span> <span class="o">=</span> <span class="s1">&#39;mousedown&#39;</span><span class="p">;</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">endEvent</span> <span class="o">=</span> <span class="s1">&#39;mouseup&#39;</span><span class="p">;</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">moveEvent</span> <span class="o">=</span> <span class="s1">&#39;mousemove&#39;</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">this</span><span class="p">.</span><span class="nx">attach</span><span class="p">();</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-303">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-303">&#182;</a>               </div>               <p>public methods</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">attach</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">startEvent</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">bound</span><span class="p">.</span><span class="nx">start</span><span class="p">);</span>
	<span class="p">},</span>

	<span class="nx">detach</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">startEvent</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">bound</span><span class="p">.</span><span class="nx">start</span><span class="p">);</span>
	<span class="p">},</span>

	<span class="nx">getEvent</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
	  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">event</span><span class="p">;</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-304">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-304">&#182;</a>               </div>               <p>protected methods</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-305">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-305">&#182;</a>               </div>               <p>this prevents the copy-paste dialog to show up when dragging. it only affects mobile safari.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">WebkitUserSelect</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>

		<span class="k">this</span><span class="p">.</span><span class="nx">hasDragged</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

		<span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">moveEvent</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">bound</span><span class="p">.</span><span class="nx">move</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">endEvent</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">bound</span><span class="p">.</span><span class="nx">end</span><span class="p">);</span>

		<span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getPage</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>

		<span class="k">this</span><span class="p">.</span><span class="nx">event</span> <span class="o">=</span> <span class="nx">event</span><span class="p">;</span>

		<span class="k">this</span><span class="p">.</span><span class="nx">startX</span> <span class="o">=</span> <span class="nx">page</span><span class="p">.</span><span class="nx">pageX</span><span class="p">;</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">startY</span> <span class="o">=</span> <span class="nx">page</span><span class="p">.</span><span class="nx">pageY</span><span class="p">;</span>

		<span class="k">this</span><span class="p">.</span><span class="nx">fireEvent</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nx">event</span><span class="p">]);</span>
	<span class="p">},</span>

	<span class="nx">move</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>

		<span class="k">this</span><span class="p">.</span><span class="nx">hasDragged</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

		<span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getPage</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>

		<span class="k">this</span><span class="p">.</span><span class="nx">deltaX</span> <span class="o">=</span> <span class="nx">page</span><span class="p">.</span><span class="nx">pageX</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">startX</span><span class="p">;</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">deltaY</span> <span class="o">=</span> <span class="nx">page</span><span class="p">.</span><span class="nx">pageY</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">startY</span><span class="p">;</span>

		<span class="k">this</span><span class="p">.</span><span class="nx">fireEvent</span><span class="p">(</span><span class="s1">&#39;move&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nx">event</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">deltaX</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">deltaY</span><span class="p">]);</span>
	<span class="p">},</span>

	<span class="nx">end</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-306">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-306">&#182;</a>               </div>               <p>we re-enable the copy-paste dialog on drag end</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">WebkitUserSelect</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

		<span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">moveEvent</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">bound</span><span class="p">.</span><span class="nx">move</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">endEvent</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">bound</span><span class="p">.</span><span class="nx">end</span><span class="p">);</span>

		<span class="k">this</span><span class="p">.</span><span class="nx">fireEvent</span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">hasDragged</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;end&#39;</span> <span class="o">:</span> <span class="s1">&#39;cancel&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nx">event</span><span class="p">]);</span>
	<span class="p">},</span>

	<span class="nx">preventDefault</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">)</span> <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
		<span class="k">else</span> <span class="nx">event</span><span class="p">.</span><span class="nx">returnValue</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
	<span class="p">},</span>

	<span class="nx">getPage</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span></pre></div>             </td>           </tr>                               <tr id="section-307">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-307">&#182;</a>               </div>               <p>when on mobile safari, the coordinates information is inside the targetTouches object</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">targetTouches</span><span class="p">)</span> <span class="nx">event</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">targetTouches</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">pageX</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">event</span><span class="p">.</span><span class="nx">pageY</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span><span class="nx">pageX</span><span class="o">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">pageX</span><span class="p">,</span> <span class="nx">pageY</span><span class="o">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">pageY</span><span class="p">};</span>
		<span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="nb">document</span><span class="p">.</span><span class="nx">compatMode</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">compatMode</span> <span class="o">==</span> <span class="s1">&#39;CSS1Compat&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span> <span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">{</span><span class="nx">pageX</span><span class="o">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">clientX</span> <span class="o">+</span> <span class="nx">element</span><span class="p">.</span><span class="nx">scrollLeft</span><span class="p">,</span> <span class="nx">pageY</span><span class="o">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">clientY</span> <span class="o">+</span> <span class="nx">element</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">};</span>
	<span class="p">}</span>

<span class="p">});</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 